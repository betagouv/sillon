"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[1052],{3905:(e,t,i)=>{i.d(t,{Zo:()=>c,kt:()=>f});var r=i(7294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function s(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function l(e,t){if(null==e)return{};var i,r,n=function(e,t){if(null==e)return{};var i,r,n={},a=Object.keys(e);for(r=0;r<a.length;r++)i=a[r],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)i=a[r],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var u=r.createContext({}),o=function(e){var t=r.useContext(u),i=t;return e&&(i="function"==typeof e?e(t):s(s({},t),e)),i},c=function(e){var t=o(e.components);return r.createElement(u.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var i=e.components,n=e.mdxType,a=e.originalType,u=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=o(i),m=n,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||a;return i?r.createElement(f,s(s({ref:t},c),{},{components:i})):r.createElement(f,s({ref:t},c))}));function f(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=i.length,s=new Array(a);s[0]=m;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l[p]="string"==typeof e?e:n,s[1]=l;for(var o=2;o<a;o++)s[o]=i[o];return r.createElement.apply(null,s)}return r.createElement.apply(null,i)}m.displayName="MDXCreateElement"},8686:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>o});var r=i(7462),n=(i(7294),i(3905));const a={hide_table_of_contents:!0},s="S\xe9curiser les URLs des fichiers h\xe9berg\xe9s",l={unversionedId:"security/secure-hosted-files-urls",id:"security/secure-hosted-files-urls",title:"S\xe9curiser les URLs des fichiers h\xe9berg\xe9s",description:"Que nous utilisions un h\xe9bergement de fichiers en base ou via des buckets S3, il faut garantir que les URLs de nos fichiers sensibles soient \xe9ph\xe9m\xe8res. M\xeame si vous avez un identifiant de fichier al\xe9atoire (UUID) et que vous estimez qu'on ne peut pas deviner l'URL :",source:"@site/docs/security/secure-hosted-files-urls.mdx",sourceDirName:"security",slug:"/security/secure-hosted-files-urls",permalink:"/docs/security/secure-hosted-files-urls",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/security/secure-hosted-files-urls.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Configurer les headers HTTP",permalink:"/docs/security/http-headers"},next:{title:"Se pr\xe9munir des fichiers infect\xe9s",permalink:"/docs/security/avoid-infected-files"}},u={},o=[],c={toc:o},p="wrapper";function d(e){let{components:t,...i}=e;return(0,n.kt)(p,(0,r.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"s\xe9curiser-les-urls-des-fichiers-h\xe9berg\xe9s"},"S\xe9curiser les URLs des fichiers h\xe9berg\xe9s"),(0,n.kt)("p",null,"Que nous utilisions ",(0,n.kt)("a",{parentName:"p",href:"/docs/database-for-everything/file-storage"},"un h\xe9bergement de fichiers en base ou via des buckets S3"),", il faut garantir que les URLs de nos fichiers sensibles soient \xe9ph\xe9m\xe8res. M\xeame si vous avez un identifiant de fichier al\xe9atoire (UUID) et que vous estimez qu'on ne peut pas deviner l'URL :"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"L'URL peut \xeatre gard\xe9e dans l'historique de navigation ;"),(0,n.kt)("li",{parentName:"ul"},"L'utilisateur l\xe9gitime peut l'avoir stock\xe9e dans un autre endroit visible par d'autres ;"),(0,n.kt)("li",{parentName:"ul"},"L'utilisateur peut ne plus \xeatre l\xe9gitime pour voir ce fichier.")),(0,n.kt)("p",null,"En ajoutant une dur\xe9e de validit\xe9 \xe0 l'URL du fichier vous garantissez que le fichier ne sera vu que dans le contexte o\xf9 l'utilisateur aura communiqu\xe9 avec l'API. ",(0,n.kt)("em",{parentName:"p"},"Bien entendu, pour des fichiers publics qui peuvent \xeatre index\xe9s (logos\u2026), il n'y a aucune raison d'y ajouter une s\xe9curit\xe9.")),(0,n.kt)("p",null,"L'id\xe9e est de donner une validit\xe9 \xe0 notre URL en y ajoutant en param\xe8tre une signature (g\xe9n\xe9r\xe9e par chiffrement). Imaginons que nous sommes dans une SPA (les appels API se font en asynchrone du chargement de page) :"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"L'utilisateur va sur ",(0,n.kt)("inlineCode",{parentName:"li"},"monsite.com/compte")," ;"),(0,n.kt)("li",{parentName:"ol"},"Le frontend demande \xe0 l'API de r\xe9cup\xe9rer l'objet utilisateur ;"),(0,n.kt)("li",{parentName:"ol"},"L'API :",(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},"R\xe9cup\xe8re l'utilisateur en base de donn\xe9es et voit que la propri\xe9t\xe9 ",(0,n.kt)("inlineCode",{parentName:"li"},"private_photo")," est une pi\xe8ce jointe qui a l'identifiant 123 ;"),(0,n.kt)("li",{parentName:"ol"},"Passe l'identifiant dans un petit helper qui va d'abord g\xe9n\xe9rer l'url finale ",(0,n.kt)("inlineCode",{parentName:"li"},"monsite.com/fichier?id=123")," ;"),(0,n.kt)("li",{parentName:"ol"},"Puis g\xe9n\xe9rer un JWT avec comme payload ",(0,n.kt)("inlineCode",{parentName:"li"},"urn:claim:file_id = 123")," et une validit\xe9 de 10 minutes pour ensuite l'ajouter en param\xe8tre pour donner ",(0,n.kt)("inlineCode",{parentName:"li"},"monsite.com/fichier?id=123?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cm46Y2xhaW06ZmlsZV9pZCI6IjEyMyIsImlhdCI6MTUxNjIzOTAyMn0.xpP88WITmYZ-F0l1iL_VbAcc-PBU53xeE4Dnm-M9Pj4")," ;"),(0,n.kt)("li",{parentName:"ol"},"Renvoie l'objet utilisateur avec pour ",(0,n.kt)("inlineCode",{parentName:"li"},"private_photo")," l'URL finale.")))),(0,n.kt)("p",null,"C'est tr\xe8s sch\xe9matis\xe9 mais c'est l'id\xe9e. Ainsi le endpoint ",(0,n.kt)("inlineCode",{parentName:"p"},"/fichier")," a juste \xe0 v\xe9rifier la validit\xe9 du JWT avec n'importe quelle librairie JWT classique."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Si vous utilisez les buckets S3 : certains providers de buckets S3 ont cette fonctionnalit\xe9 de signature d'URL, il faut donc que votre backend se charge de signer l'URL avec la librairie cliente du provider ;"),(0,n.kt)("li",{parentName:"ul"},"Sinon si vous \xeates en base de donn\xe9es il faut cr\xe9er vous-m\xeame ce petit helper.")),(0,n.kt)("p",null,"Le b\xe9n\xe9fice d'avoir la g\xe9n\xe9ration de l'URL sign\xe9e quand on r\xe9cup\xe8re la donn\xe9e m\xe9tier est que vous passez forc\xe9ment par les \xe9tapes de v\xe9rification des droits d'acc\xe8s. Vous \xe9vitez ainsi de centraliser les droits d'acc\xe8s au niveau de la table de fichiers (qui ont des risques d'\xeatre d\xe9synchronis\xe9s avec les vrais entit\xe9s m\xe9tiers)."),(0,n.kt)("p",null,"Quelques points importants (que ce soit en base ou via S3 directement) :"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"La validit\xe9 du JWT n'a pas besoin d'\xeatre tr\xe8s longue puisque aussit\xf4t le frontend r\xe9cup\xe8re les donn\xe9es, aussit\xf4t il va charger le fichier (le fichier peut \xeatre gard\xe9 en cache) ;"),(0,n.kt)("li",{parentName:"ul"},"En l'\xe9tat actuel des choses, la mise en cache ne va pas marcher car le JWT est diff\xe9rent \xe0 chaque affichage de page. La technique est de rendre fixe l'URL sur un intervalle donn\xe9 (ce n'est pas parfait, mais \xe7a fait le travail) :",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Au moment de g\xe9n\xe9rer le JWT on sp\xe9cifie la date d'expiration en utilisant un modulo (de 10 minutes par exemple) ;"),(0,n.kt)("li",{parentName:"ul"},'Les expirations se font donc \xe0 des "heures fixes" (1h10, 1h20, 1h30\u2026) ;'))),(0,n.kt)("li",{parentName:"ul"},"Assurez-vous quand m\xeame sur votre endpoint de renvoyer le header HTTP ",(0,n.kt)("inlineCode",{parentName:"li"},"Cache-Control")," afin d'adapter le contexte et de ne pas garder localement des images dont la validit\xe9 a expir\xe9 :",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Pour un fichier public avec la valeur : ",(0,n.kt)("inlineCode",{parentName:"li"},"public, immutable, no-transform, max-age=0")),(0,n.kt)("li",{parentName:"ul"},"Pour un fichier priv\xe9 avec la valeur : ",(0,n.kt)("inlineCode",{parentName:"li"},"private, max-age=${minutesToSeconds(15)}"),".")))),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"D\xe9sol\xe9s si l'ensemble para\xeet \xeatre un peu de travail, mais c'est le n\xe9cessaire pour s\xe9curiser proprement les fichiers (l'utilisation d'un S3 prend en charge quelques \xe9tapes mais laisse reposer sur vous l'architecture de s\xe9curisation ainsi que sa mise en place).")))}d.isMDXComponent=!0}}]);