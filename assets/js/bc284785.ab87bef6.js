"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[5732],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>f});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var u=n.createContext({}),l=function(e){var t=n.useContext(u),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=l(e.components);return n.createElement(u.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,s=e.originalType,u=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=l(r),m=a,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||s;return r?n.createElement(f,i(i({ref:t},c),{},{components:r})):n.createElement(f,i({ref:t},c))}));function f(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=r.length,i=new Array(s);i[0]=m;var o={};for(var u in t)hasOwnProperty.call(t,u)&&(o[u]=t[u]);o.originalType=e,o[p]="string"==typeof e?e:a,i[1]=o;for(var l=2;l<s;l++)i[l]=r[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},6889:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>P,contentTitle:()=>j,default:()=>O,frontMatter:()=>w,metadata:()=>I,toc:()=>E});var n=r(7462),a=r(7294),s=r(3905),i=r(6010);const o={tabItem:"tabItem_Ymn6"};function u(e){let{children:t,hidden:r,className:n}=e;return a.createElement("div",{role:"tabpanel",className:(0,i.Z)(o.tabItem,n),hidden:r},t)}var l=r(2466),c=r(6550),p=r(1980),d=r(7392),m=r(12);function f(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:r,attributes:n,default:a}}=e;return{value:t,label:r,attributes:n,default:a}}))}function b(e){const{values:t,children:r}=e;return(0,a.useMemo)((()=>{const e=t??f(r);return function(e){const t=(0,d.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,r])}function h(e){let{value:t,tabValues:r}=e;return r.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:r}=e;const n=(0,c.k6)(),s=function(e){let{queryString:t=!1,groupId:r}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:t,groupId:r});return[(0,p._X)(s),(0,a.useCallback)((e=>{if(!s)return;const t=new URLSearchParams(n.location.search);t.set(s,e),n.replace({...n.location,search:t.toString()})}),[s,n])]}function v(e){const{defaultValue:t,queryString:r=!1,groupId:n}=e,s=b(e),[i,o]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!h({value:t,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const n=r.find((e=>e.default))??r[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:s}))),[u,l]=g({queryString:r,groupId:n}),[c,p]=function(e){let{groupId:t}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(t),[n,s]=(0,m.Nk)(r);return[n,(0,a.useCallback)((e=>{r&&s.set(e)}),[r,s])]}({groupId:n}),d=(()=>{const e=u??c;return h({value:e,tabValues:s})?e:null})();(0,a.useLayoutEffect)((()=>{d&&o(d)}),[d]);return{selectedValue:i,selectValue:(0,a.useCallback)((e=>{if(!h({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);o(e),l(e),p(e)}),[l,p,s]),tabValues:s}}var k=r(2389);const y={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function N(e){let{className:t,block:r,selectedValue:s,selectValue:o,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:p}=(0,l.o5)(),d=e=>{const t=e.currentTarget,r=c.indexOf(t),n=u[r].value;n!==s&&(p(t),o(n))},m=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const r=c.indexOf(e.currentTarget)+1;t=c[r]??c[0];break}case"ArrowLeft":{const r=c.indexOf(e.currentTarget)-1;t=c[r]??c[c.length-1];break}}t?.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":r},t)},u.map((e=>{let{value:t,label:r,attributes:o}=e;return a.createElement("li",(0,n.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>c.push(e),onKeyDown:m,onClick:d},o,{className:(0,i.Z)("tabs__item",y.tabItem,o?.className,{"tabs__item--active":s===t})}),r??t)})))}function q(e){let{lazy:t,children:r,selectedValue:n}=e;const s=(Array.isArray(r)?r:[r]).filter(Boolean);if(t){const e=s.find((e=>e.props.value===n));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},s.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==n}))))}function x(e){const t=v(e);return a.createElement("div",{className:(0,i.Z)("tabs-container",y.tabList)},a.createElement(N,(0,n.Z)({},e,t)),a.createElement(q,(0,n.Z)({},e,t)))}function S(e){const t=(0,k.Z)();return a.createElement(x,(0,n.Z)({key:String(t)},e))}const w={hide_table_of_contents:!0},j="Stockage de fichiers (au revoir buckets S3)",I={unversionedId:"database-for-everything/file-storage",id:"database-for-everything/file-storage",title:"Stockage de fichiers (au revoir buckets S3)",description:"Bien que le bucket S3 soit devenu une r\xe9f\xe9rence voire m\xeame le choix par d\xe9faut quand on commence un projet, on aimerait vous mettre en garde en red\xe9taillant l'int\xe9gration d'un bucket S3 au sein d'un applicatif.",source:"@site/docs/database-for-everything/file-storage.mdx",sourceDirName:"database-for-everything",slug:"/database-for-everything/file-storage",permalink:"/docs/database-for-everything/file-storage",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/database-for-everything/file-storage.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Un seul espace de stockage, \xe7a serait le r\xeave ?",permalink:"/docs/database-for-everything/dream-of-unique-storage"},next:{title:"Job queues / message broker",permalink:"/docs/database-for-everything/jobs"}},P={},E=[],T={toc:E},L="wrapper";function O(e){let{components:t,...r}=e;return(0,s.kt)(L,(0,n.Z)({},T,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"stockage-de-fichiers-au-revoir-buckets-s3"},"Stockage de fichiers (au revoir buckets S3)"),(0,s.kt)("p",null,"Bien que le bucket S3 soit devenu une r\xe9f\xe9rence voire m\xeame le choix par d\xe9faut quand on commence un projet, ",(0,s.kt)("strong",{parentName:"p"},"on aimerait vous mettre en garde")," en red\xe9taillant l'int\xe9gration d'un bucket S3 au sein d'un applicatif."),(0,s.kt)("p",null,"Si vous utilisez du S3 vous allez normalement stocker vos fichiers dans un espace distinct de votre base de donn\xe9es. Chaque fichier aura une URL unique, et dans votre base de donn\xe9es vous garderez en r\xe9f\xe9rence cette URL. Vous vous retrouvez dans la situation o\xf9 les deux peuvent ne plus \xeatre synchronis\xe9s, avoir l'URL dans votre base de donn\xe9es ne veut pas dire que le fichier existe sur votre bucket S3."),(0,s.kt)("p",null,"Sachez qu'une PostgreSQL est capable de g\xe9rer au sein d'une colonne des fichiers faisant maximum 1 Go chacun, il faut pour cela utiliser le type ",(0,s.kt)("inlineCode",{parentName:"p"},"BYTEA")," (qui utilise le ",(0,s.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/storage-toast.html"},"TOAST"),")."),(0,s.kt)("admonition",{title:"Information",type:"note"},(0,s.kt)("p",{parentName:"admonition"},'Il existe aussi la possibilit\xe9 de stocker des "',(0,s.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/largeobjects.html"},"large objects"),"\" qui peuvent faire jusqu'\xe0 4 To chacun, il faut une \xe9tape suppl\xe9mentaire pour les ajouter avant de les r\xe9f\xe9rencer dans une table traditionnelle. Et cela pose des questions de volum\xe9trie qui seront abord\xe9s plus loin.")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Vous devez sp\xe9cifier et quantifier ce que vous allez h\xe9berger pour dire oui ou non aux buckets S3.")),(0,s.kt)("p",null,"Un \xe9l\xe9ment important qui est mentionn\xe9 dans ",(0,s.kt)("a",{parentName:"p",href:"/docs/legal/data-lifecycle"},"le chapitre l\xe9gal")," et qui doit \xeatre pris en compte dans votre calcul : ",(0,s.kt)("strong",{parentName:"p"},"la CNIL recommande de ne pas conserver les donn\xe9es utilisateurs plus de 2 ans"),"."),(0,s.kt)("p",null,"Cas concrets :"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Si je sais que mon produit ne va h\xe9berger que des photos de profil des agents publics et les logos de toutes les collectivit\xe9s de France. Je sais d'avance que la totalit\xe9 des fichiers ne d\xe9passera jamais une certaine limite. ",(0,s.kt)("strong",{parentName:"li"},"Ma PostgreSQL suffit")," ;"),(0,s.kt)("li",{parentName:"ol"},"Si mon outil re\xe7oit des demandes de m\xe9diations et que chaque citoyen et agent public peut ajouter \xe0 chaque demande des pi\xe8ces justificatives (limit\xe9es \xe0 5 Mo chacune), a priori il n'y a pas de limite (cela peut \xeatre exponentiel). Sauf que l'on sait historiquement qu'il y a en moyenne 5 fichiers par dossier, et 10 000 dossiers cr\xe9\xe9s par an. Comme l'outil supprime les dossiers apr\xe8s 2 ans pour respecter la recommandation CNIL, le stockage reste acceptable et une ",(0,s.kt)("strong",{parentName:"li"},"PostgreSQL devrait suffire")," ;"),(0,s.kt)("li",{parentName:"ol"},"Si mon outil archive les m\xe9dias r\xe9alis\xe9s durant des \xe9v\xe9nements publiques, j'accepte ainsi des photos en haute qualit\xe9 (10 Mo ou plus) et des vid\xe9os qui peuvent faire plusieurs heures (plusieurs Go). De plus, du fait de la volont\xe9 d'archiver la recommandation CNIL n'est pas appliqu\xe9e. Je me retrouve avec un enjeu strat\xe9gique sur le stockage, ",(0,s.kt)("strong",{parentName:"li"},"ma PostgreSQL n'est pas adapt\xe9e, je choisis du S3"),".")),(0,s.kt)("p",null,"Points importants (hors probl\xe9matiques de stockage) :"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Nous devons rester sur des tailles de fichiers acceptables quand on passe via PostgreSQL car c'est notre propre API qui sera sollicit\xe9e pour servir le flux ;"),(0,s.kt)("li",{parentName:"ul"},"En utilisant une base PostgreSQL pour le stockage ",(0,s.kt)("strong",{parentName:"li"},"il ne faut jamais essayer de produire vous-m\xeame la logique d'upload d'un fichier"),'. Cela implique beaucoup de technique : headers HTTP, le "resumable upload" (fait de reprendre une upload si la connexion internet est perdue durant quelques secondes)\u2026 ',(0,s.kt)("strong",{parentName:"li"},"Nous pr\xe9conisons plut\xf4t d'utiliser ",(0,s.kt)("a",{parentName:"strong",href:"https://github.com/tus"},(0,s.kt)("inlineCode",{parentName:"a"},"tus")))," (",(0,s.kt)("a",{parentName:"li",href:"https://github.com/tus/tus-js-client"},"client")," et ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/tus/tus-node-server"},"serveur"),") sachant qu'ils proposent ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/tus/tus-node-server/tree/main/packages/server#example-integrate-tus-into-nextjs"},"une int\xe9gration dans l'API Next.js")," ;"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Si vous utilisez des buckets S3, ne faites pas transiter les fichiers par votre API.")," Vous avez s\xfbrement choisi S3 car il est question de volum\xe9trie importante. Le fait d'utiliser votre API en interm\xe9diaire met un point de congestion et fait reposer sur vous le fait de bien dimensionner votre API alors qu'une upload/lecture peut \xeatre anecdotique (",(0,s.kt)("strong",{parentName:"li"},"sachant que \xe7a peut en plus perturber vos op\xe9rations sensibles sur l'API"),'). Nous recommandons dans ce cas de choisir un fournisseur S3 qui permet de "signer des URLs" que ce soit en lecture ou en upload. Avec cette architecture aucun fichier ne transite via votre API :',(0,s.kt)("ol",{parentName:"li"},(0,s.kt)("li",{parentName:"ol"},'Votre frontend demande \xe0 l\'API "je veux uploader un fichier" ;'),(0,s.kt)("li",{parentName:"ol"},"L'API renvoie une nouvelle URL sign\xe9e du provider S3 ;"),(0,s.kt)("li",{parentName:"ol"},"Le frontend peut uploader son fichier directement sur l'URL sign\xe9e (en utilisant une librairie cliente compatible comme ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/tus/tus-js-client"},(0,s.kt)("inlineCode",{parentName:"a"},"tus")),") et obtient l'URL finale du fichier upload\xe9 ;"),(0,s.kt)("li",{parentName:"ol"},"Le frontend peut transmettre l'URL du fichier upload\xe9 \xe0 l'API ;"),(0,s.kt)("li",{parentName:"ol"},"L'API est en mesure de valider le fichier de fa\xe7on synchrone (ou non), et d'enregister l'URL en base de donn\xe9es.")))),(0,s.kt)("p",null,"Notez que ",(0,s.kt)("strong",{parentName:"p"},"les technologies comme ",(0,s.kt)("inlineCode",{parentName:"strong"},"tus")," ou S3 ne g\xe8rent pas les r\xe8gles de s\xe9curit\xe9 propres \xe0 votre m\xe9tier")," (qui peut uploader ? qui peut lire ce fichier ?). C'est \xe0 vous de g\xe9rer cette partie. Nous abordons cela plus en d\xe9tail dans ",(0,s.kt)("a",{parentName:"p",href:"/docs/security/secure-hosted-files-urls"},"le chapitre sur la s\xe9curit\xe9"),"."),(0,s.kt)("admonition",{type:"info"},(0,s.kt)("p",{parentName:"admonition"},"\xc9crire et lire des fichiers dans votre base de donn\xe9es va forc\xe9ment utiliser un peu plus de ressources (notamment la bande passante). N'h\xe9sitez pas \xe0 \"augmenter\" les performances de votre base si besoin, et \xe0 dimensionner le tuyau d'entr\xe9e pour faire passer les fichiers :"),(0,s.kt)(S,{mdxType:"Tabs"},(0,s.kt)(u,{value:"nextjs",label:"Next.js",mdxType:"TabItem"},"Il faudrait augmenter la configuration dans le fichier du endpoint d'upload en exportant par exemple :",(0,s.kt)("pre",{parentName:"admonition"},(0,s.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="my-endpoint.tsx"',title:'"my-endpoint.tsx"'},"export const config = {\n  api: {\n    bodyParser: {\n      sizeLimit: '10mb',\n    },\n  },\n};\n")),"  "),(0,s.kt)(u,{value:"nginx",label:"Nginx",mdxType:"TabItem"},"Il faudrait augmenter la configuration :",(0,s.kt)("pre",{parentName:"admonition"},(0,s.kt)("code",{parentName:"pre",className:"language-conf",metastring:'title="/etc/nginx/http.d/default.conf"',title:'"/etc/nginx/http.d/default.conf"'},"server {\n  listen 80;\n  client_max_body_size 10M;\n}\n")),"  "))))}O.isMDXComponent=!0}}]);