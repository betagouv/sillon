"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[5188],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var o=a.createContext({}),u=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=u(e.components);return a.createElement(o.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(t),g=i,m=p["".concat(o,".").concat(g)]||p[g]||d[g]||r;return t?a.createElement(m,s(s({ref:n},c),{},{components:t})):a.createElement(m,s({ref:n},c))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,s=new Array(r);s[0]=g;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l[p]="string"==typeof e?e:i,s[1]=l;for(var u=2;u<r;u++)s[u]=t[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},2216:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>u});var a=t(7462),i=(t(7294),t(3905));const r={hide_table_of_contents:!0},s="Connection SSH et signature de commit avec une cl\xe9 de s\xe9curit\xe9",l={unversionedId:"go-further/setup-security-key",id:"go-further/setup-security-key",title:"Connection SSH et signature de commit avec une cl\xe9 de s\xe9curit\xe9",description:"Comme indiqu\xe9 dans la section 2FA / Security keys, les cl\xe9s de s\xe9curit\xe9s (comme les Yubikey) sont des clefs USB/dongles utilis\xe9s principalement pour s\xe9curiser l'authentification des utilisateurs \xe0 leur compte, mais pas seulement.",source:"@site/docs/go-further/setup-security-key.mdx",sourceDirName:"go-further",slug:"/go-further/setup-security-key",permalink:"/docs/go-further/setup-security-key",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/go-further/setup-security-key.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Strat\xe9gie pour d\xe9velopper plusieurs produits num\xe9riques",permalink:"/docs/go-further/multiple-products-stategy"},next:{title:"Contribuer \xe0 cette base de connaissances",permalink:"/docs/go-further/contribute-this-knowledge-base"}},o={},u=[{value:"<strong>Installation</strong>",id:"installation",level:2},{value:"Initialiser une nouvell\xe9 cl\xe9",id:"initialiser-une-nouvell\xe9-cl\xe9",level:3},{value:"<strong>Authentification par passkeys</strong>",id:"authentification-par-passkeys",level:2},{value:"<strong>Gestion des clefs SSH</strong>",id:"gestion-des-clefs-ssh",level:2},{value:"<strong>Cr\xe9ation</strong>",id:"cr\xe9ation",level:3},{value:"<strong>Visualisation avec la libfido2</strong>",id:"visualisation-avec-la-libfido2",level:3},{value:"Alternative sur une Yubikey",id:"alternative-sur-une-yubikey",level:4},{value:"<strong>Import sur une machine</strong>",id:"import-sur-une-machine",level:3},{value:"Ajout de la cl\xe9 sur Github",id:"ajout-de-la-cl\xe9-sur-github",level:3},{value:"<strong>Utilisation dans git</strong>",id:"utilisation-dans-git",level:3},{value:"<strong>Signer ses commits avec une cl\xe9 de s\xe9curit\xe9 </strong>",id:"signer-ses-commits-avec-une-cl\xe9-de-s\xe9curit\xe9-",level:2},{value:"Signer avec une cl\xe9 SSH (version recommand\xe9)",id:"signer-avec-une-cl\xe9-ssh-version-recommand\xe9",level:3},{value:"Ajout de la cl\xe9 sur Github",id:"ajout-de-la-cl\xe9-sur-github-1",level:4},{value:"Indiquer la cl\xe9 SSH de signature \xe0 Git",id:"indiquer-la-cl\xe9-ssh-de-signature-\xe0-git",level:4},{value:"Installer et configurer GnuPG (version alternative)",id:"installer-et-configurer-gnupg-version-alternative",level:3},{value:"<strong>Test de l&#39;installation</strong>",id:"test-de-linstallation",level:3},{value:"<strong>Modifier les codes PIN et admin PIN</strong>",id:"modifier-les-codes-pin-et-admin-pin",level:3},{value:"<strong>Modifier les attributs de cl\xe9</strong>",id:"modifier-les-attributs-de-cl\xe9",level:3},{value:"<strong>Cr\xe9er sa cl\xe9 pgp</strong>",id:"cr\xe9er-sa-cl\xe9-pgp",level:3},{value:"<strong>V\xe9rifier sa cl\xe9 pgp</strong>",id:"v\xe9rifier-sa-cl\xe9-pgp",level:3},{value:"<strong>Exporter sa cl\xe9 publique pgp</strong>",id:"exporter-sa-cl\xe9-publique-pgp",level:3},{value:"<strong>Importer sa cl\xe9 publique pgp dans Github</strong>",id:"importer-sa-cl\xe9-publique-pgp-dans-github",level:3},{value:"<strong>Configurer Git pour la signature \xe9lectronique</strong>",id:"configurer-git-pour-la-signature-\xe9lectronique",level:3},{value:"<strong>Effectuer son premier commit Git Sign\xe9</strong>",id:"effectuer-son-premier-commit-git-sign\xe9",level:3},{value:"<strong>Aller plus loin</strong>",id:"aller-plus-loin",level:2}],c={toc:u},p="wrapper";function d(e){let{components:n,...t}=e;return(0,i.kt)(p,(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"connection-ssh-et-signature-de-commit-avec-une-cl\xe9-de-s\xe9curit\xe9"},"Connection SSH et signature de commit avec une cl\xe9 de s\xe9curit\xe9"),(0,i.kt)("p",null,"Comme indiqu\xe9 dans la section 2FA / Security keys, les cl\xe9s de s\xe9curit\xe9s (comme les Yubikey) sont des clefs USB/dongles utilis\xe9s principalement pour s\xe9curiser l'authentification des utilisateurs \xe0 leur compte, mais pas seulement.\nElles peuvent aussi servir \xe0 authentifier les commits git."),(0,i.kt)("p",null,"Pour la suite de cette documentation Le type de cl\xe9 (Yubikey USB-C, USB-A, etc.) n'est pas important. En revanche, nous travaillerons avec cl\xe9 compatible FIDO2 et PGP.\nNormalement (\xe0 par l'utilitaire ykman), ces commandes fonctionnent pour toutes les cl\xe9s compatibles FIDO2 (pour les acc\xe8s SSH/Passkeys) et carte \xe0 puce (pour la partie PGP)"),(0,i.kt)("h2",{id:"installation"},(0,i.kt)("strong",{parentName:"h2"},"Installation")),(0,i.kt)("p",null,"Pour ce tutoriel, nous allons utilisez la bibiliotheque fido2 : ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yubico/libfido2?tab=readme-ov-file#installation"},"https://github.com/Yubico/libfido2?tab=readme-ov-file#installation")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Il existe comme alternatice le Yubikey-manager si vous avez une Yubikey : la documentation pour l'installer : ",(0,i.kt)("a",{parentName:"p",href:"https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html"},"https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html"),"\nIl existe aussi fido-manager.")),(0,i.kt)("h3",{id:"initialiser-une-nouvell\xe9-cl\xe9"},"Initialiser une nouvell\xe9 cl\xe9"),(0,i.kt)("p",null,"La premi\xe8re chose \xe0 faire, apr\xe8s avoir branch\xe9 votre cl\xe9, est definir de d\xe9finir un code PIN."),(0,i.kt)("p",null,"Voici comment faire avec la libfido2 :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# fido2-token -L\nDevSrvsID:876876876: vendor=0x1050, product=0x0407 (Yubico YubiKey OTP+FIDO+CCID)\n")),(0,i.kt)("p",null,"Copier la partie ",(0,i.kt)("inlineCode",{parentName:"p"},"DevSrvsID:876876876")," (cela peut \xeatre ",(0,i.kt)("inlineCode",{parentName:"p"},"/dev/hidraw*")," sous linux ou ",(0,i.kt)("inlineCode",{parentName:"p"},"DevSrvsID:******")," sous mac)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# fido2-token -S DevSrvsID:876876876\nEnter new PIN for DevSrvsID:876876876:\nEnter same PIN again:\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Mettez un code PIN \xe0 6 chiffres (ou plus si vous le souhaitez)")),(0,i.kt)("h2",{id:"authentification-par-passkeys"},(0,i.kt)("strong",{parentName:"h2"},"Authentification par passkeys")),(0,i.kt)("h2",{id:"gestion-des-clefs-ssh"},(0,i.kt)("strong",{parentName:"h2"},"Gestion des clefs SSH")),(0,i.kt)("p",null,"FIDO2 est un standard d'authentification sans mot de passe qui utilise la cryptographie \xe0 cl\xe9 publique pour s\xe9curiser les connexions en ligne.\nFido2 fonctionne avec SSH de la mani\xe8re suivante :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"la clef publique est partag\xe9e avec l'h\xf4te distant"),(0,i.kt)("li",{parentName:"ul"},"la clef priv\xe9e n'est pas r\xe9ellement stock\xe9e sur la machine locale : le fichier de clef priv\xe9 contient un ID qui r\xe9f\xe9rence la clef priv\xe9e stock\xe9e sur la yubikey")),(0,i.kt)("h3",{id:"cr\xe9ation"},(0,i.kt)("strong",{parentName:"h3"},"Cr\xe9ation")),(0,i.kt)("p",null,"La cr\xe9ation d'une clef se fait via l'utilitaire ssh-keygen :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519-sk -O resident -O application=ssh:github\n")),(0,i.kt)("p",null,"Au moment o\xf9 cette commande est valid\xe9e, le code PIN de la yubikey sera demand\xe9.\nOn vous demande o\xf9 stocker la cl\xe9, choisissez le r\xe9pertoire ",(0,i.kt)("inlineCode",{parentName:"p"},"~/.ssh/id_ed25519_sk_rk_github"),".\nVous n'avez pas besoin de mettre une passphrase."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},'L\'option "-O resident" sp\xe9cifie que la clef priv\xe9e est stock\xe9e dans la yubikey.\nL\'option "-O application=ssh:github" indique que la clef ssh g\xe9n\xe9r\xe9e aura pour ID "ssh:github" dans la yubikey.\nDans le cas o\xf9 on doit g\xe9n\xe9rer une autre clef SSH, on lui sp\xe9cifiera un autre nom.')),(0,i.kt)("p",null,'Dans la commande suivante, elle aura pour ID "ssh:infra-prod" pour se connecter \xe0 votre infra (si vous avez besoin).'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519-sk -O resident -O application=ssh:infra-prod\n")),(0,i.kt)("h3",{id:"visualisation-avec-la-libfido2"},(0,i.kt)("strong",{parentName:"h3"},"Visualisation avec la libfido2")),(0,i.kt)("p",null,"Pour visualiser les cl\xe9s pr\xe9c\xe9demment cr\xe9\xe9es saisir la commande suivante :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# fido2-token -L\nDevSrvsID:876876876: vendor=0x1050, product=0x0407 (Yubico YubiKey OTP+FIDO+CCID)\n# fido2-token -L -r DevSrvsID:876876876\nEnter PIN for DevSrvsID:876876876:\n00: QHqudhq!D767QDhnqiUDhQ8D9hqD8qhjd9HQJ8DJQ9Q= ssh:github\n01: ds!qh!QSUNIDUIHqdjk465bU898DQBNJKQ898DS89Q8= ssh:infra-prod\n")),(0,i.kt)("p",null,"On a bien deux clefs ssh r\xe9f\xe9renc\xe9es sous 2 ID diff\xe9rents."),(0,i.kt)("h4",{id:"alternative-sur-une-yubikey"},"Alternative sur une Yubikey"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ykman fido credentials list\n")),(0,i.kt)("p",null,"Apr\xe8s la saisie du code PIN, le r\xe9sultat pourra ressembler \xe0 ceci :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"Credential ID  RP ID       Username           Display name\na8f896e6...    ssh:github  openssh            openssh\ne929dde6...    ssh:infra-prod    openssh            openssh\n")),(0,i.kt)("h3",{id:"import-sur-une-machine"},(0,i.kt)("strong",{parentName:"h3"},"Import sur une machine")),(0,i.kt)("p",null,"Suite aux \xe9tapes pr\xe9c\xe9dentes, nous avons un couple de clefs priv\xe9e/publique install\xe9s sur la yubikey.\nVoici comment faire pour importer ces clefs sur une machine :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/.ssh\nssh-keygen -K\n")),(0,i.kt)("p",null,"Les clefs sont maintenant stock\xe9es dans le r\xe9pertoire ~/.ssh et peuvent \xeatre list\xe9es via :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"~/.ssh$ ls\nid_ed25519_sk_rk_github\nid_ed25519_sk_rk_github.pub\nid_ed25519_sk_rk_infra-prod\nid_ed25519_sk_rk_infra-prod.pub\n")),(0,i.kt)("h3",{id:"ajout-de-la-cl\xe9-sur-github"},"Ajout de la cl\xe9 sur Github"),(0,i.kt)("p",null,"Ajouter la cl\xe9 publique (",(0,i.kt)("inlineCode",{parentName:"p"},"~/.ssh/id_ed25519_sk_rk_github.pub"),") sur Github : ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account"},"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account"),'\nVous devez l\'ajouter comme une "authentication key".'),(0,i.kt)("h3",{id:"utilisation-dans-git"},(0,i.kt)("strong",{parentName:"h3"},"Utilisation dans git")),(0,i.kt)("p",null,"Maintenant que nos clefs sont import\xe9es sur la machine, nous allons nous en servir pour nous connecter \xe0 un d\xe9p\xf4t github.\nPour cela, nous allons configurer le fichier .ssh/config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/.ssh/\nnano config\n")),(0,i.kt)("p",null,"Saisir dans l'\xe9diteur de texte (nano ou vim ou autre) le texte suivant :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Host github.com\n  IdentityFile /home/USER/.ssh/id_ed25519_sk_rk_github\n")),(0,i.kt)("p",null,"En rempla\xe7ant ",(0,i.kt)("inlineCode",{parentName:"p"},"USER"),' par le nom de l\'utilisateur linux qui utilisera la clef.\nRemplacer "id_ed25519_sk_rk_github" par le nom du fichier de clef priv\xe9e qui devra \xeatre pr\xe9sent\xe9.'),(0,i.kt)("p",null,"Vous pouvez tester que cela fonctionne avec la commande suivante :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# ssh git@github.com\n")),(0,i.kt)("p",null,"Vous devez avoir le r\xe9sultat suivant :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Confirm user presence for key ED25519-SK SHA256:89798798798798797\nUser presence confirmed\nPTY allocation request failed on channel 0\nHi johndoe! You've successfully authenticated, but GitHub does not provide shell access.\nConnection to github.com closed.\n")),(0,i.kt)("p",null,"\xc0 noter que dans le cas o\xf9 l'on a plusieurs clefs ssh pour se connecter \xe0 plusieurs comptes github, on peut le sp\xe9cifier de mani\xe8re un peu diff\xe9rente :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"cr\xe9er le fichier /home/",(0,i.kt)("inlineCode",{parentName:"li"},"USER")," /config.d/config-github et saisir ce qui a \xe9t\xe9 pr\xe9ciser au dessus"),(0,i.kt)("li",{parentName:"ul"},"au moment de la connexion, pr\xe9ciser dans la variable d'environnement GIT_SSH_COMMAND le fichier de config ssh \xe0 utiliser :")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'GIT_SSH_COMMAND="ssh -F /home/`USER` /.ssh/config.d/config-github" git clone git@github.com:mon-orga/mon-repo.git\n')),(0,i.kt)("p",null,"Vous voil\xe0 pr\xeat \xe0 travailler avec votre d\xe9p\xf4t git !"),(0,i.kt)("h2",{id:"signer-ses-commits-avec-une-cl\xe9-de-s\xe9curit\xe9-"},(0,i.kt)("strong",{parentName:"h2"},"Signer ses commits avec une cl\xe9 de s\xe9curit\xe9 ")),(0,i.kt)("h3",{id:"signer-avec-une-cl\xe9-ssh-version-recommand\xe9"},"Signer avec une cl\xe9 SSH (version recommand\xe9)"),(0,i.kt)("p",null,"Cr\xe9ation d'une clef SSH de signature se fait via l'utilitaire ssh-keygen :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519-sk -O resident -O application=ssh:git-sign\n")),(0,i.kt)("p",null,"(Vous n'avez pas besoin de passphrase)\nVous pouvez sauvegarder ici : /home/USER/.ssh/id_ed25519_sk_rk_git-sign"),(0,i.kt)("h4",{id:"ajout-de-la-cl\xe9-sur-github-1"},"Ajout de la cl\xe9 sur Github"),(0,i.kt)("p",null,"Ajouter la cl\xe9 publique (",(0,i.kt)("inlineCode",{parentName:"p"},"~/.ssh/id_ed25519_sk_rk_github.pub"),") sur Github : ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account"},"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account"),'\nVous devez l\'ajouter comme une "signing key".'),(0,i.kt)("h4",{id:"indiquer-la-cl\xe9-ssh-de-signature-\xe0-git"},"Indiquer la cl\xe9 SSH de signature \xe0 Git"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key#telling-git-about-your-ssh-key"},"https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key#telling-git-about-your-ssh-key")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"git config --global gpg.format ssh\ngit config --global user.signingkey /home/USER/.ssh/id_ed25519_sk_rk_git-sign\n")),(0,i.kt)("p",null,"Signer un premier commit"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ git commit -S -m "signature test"\n')),(0,i.kt)("p",null,"La yubikey va clignoter, il faut la toucher."),(0,i.kt)("p",null,"Vous pouvez v\xe9rifier votre signature avec la commande suivante :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git log --show-signature\ncommit 68e204c945a95a2d8970a19552fdebcfdbb41864 (HEAD -> main)\ngpg: Signature faite le lun. 23 sept. 2024 17:14:44 CEST\ngpg:                avec la clef RSA 35FC4FCA48877127E7F0B29D2FA279039EFA1679\ngpg: Bonne signature de \xab Pipo Bimbo <heroinedor@gmail.com> \xbb [ultime]\nAuthor: Pipo Bimbo <heroinedor@gmail.com>\nDate:   Mon Sep 23 17:14:44 2024 +0200\n\n    signature test\n")),(0,i.kt)("p",null,"Activer la signature de tous les commits automatiquement dans tous les repos :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ git config --global commit.gpgsign true\n")),(0,i.kt)("p",null,"C'est bon pour la signature des commits avec votre cl\xe9 SSH ! \ud83c\udf89"),(0,i.kt)("h3",{id:"installer-et-configurer-gnupg-version-alternative"},"Installer et configurer GnuPG (version alternative)"),(0,i.kt)("p",null,"Si vous n'avez pas choisi la signature de commit avec votre cl\xe9 SSH, vous pouvez le faire avec OpenPGP."),(0,i.kt)("p",null,"OpenPGP est un standard utilis\xe9 pour la manipulation des cl\xe9s cryptographiques. Son impl\xe9mentation principale est GNU Privacy Guard (gnupg)."),(0,i.kt)("p",null,"Voici les proc\xe9dures d'installation en fonction de l'OS:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Linux")," :")),(0,i.kt)("p",null,"Installer les paquets suivant avec le package-manager (apt) : GPG, pcscd, scdaemon"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ sudo apt install pcscd gnupg2 scdaemon\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"macOS")," :")),(0,i.kt)("p",null,"Installation via homebrew"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ brew install gnupg\n")),(0,i.kt)("p",null,"Puis installation de Pinentry"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ brew install pinentry-mac\n")),(0,i.kt)("p",null,"Ajouter au fichier ~/.gnupg/gpg-agent.conf:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"pinentry-program /usr/local/bin/pinentry-mac\n")),(0,i.kt)("p",null,"Ajouter au fichier ~/.gnupg/scdaemon.conf :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"disable-ccid\n")),(0,i.kt)("h3",{id:"test-de-linstallation"},(0,i.kt)("strong",{parentName:"h3"},"Test de l'installation")),(0,i.kt)("p",null,"Une fois cette installation termin\xe9e, on peut tester le bon fonctionnement de gpg en ins\xe9rant la Yubikey dans un port USB et en tapant :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gpg --card-status\n")),(0,i.kt)("p",null,"Si ma carte est vierge alors devrait appara\xeetre le r\xe9sultat suivant :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"Reader ...........: Yubico YubiKey OTP FIDO CCID 0\nApplication ID ...: D2760001240102010006078005150000\nVersion ..........: 2.1\nManufacturer .....: Yubico\nSerial number ....: 07800515\nName of cardholder: [not set]\nLanguage prefs ...: [not set]\nSex ..............: unspecified\nURL of public key : [not set]\nLogin data .......: [not set]\nSignature PIN ....: not forced\nKey attributes ...: rsa2048 rsa2048 rsa2048\nMax. PIN lengths .: 127 127 127\nPIN retry counter : 3 0 3\nSignature counter : 0\nSignature key ....: [none]\nEncryption key....: [none]\nAuthentication key: [none]\nGeneral key info..: [none]\n")),(0,i.kt)("h3",{id:"modifier-les-codes-pin-et-admin-pin"},(0,i.kt)("strong",{parentName:"h3"},"Modifier les codes PIN et admin PIN")),(0,i.kt)("p",null,"Saisir dans un shell :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gpg --card-edit\n")),(0,i.kt)("p",null,"\u2192 on se retrouve dans un prompt gpg/card"),(0,i.kt)("p",null,"Saisir :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"gpg/carte> admin\nLes commandes d'administration sont permises\n")),(0,i.kt)("p",null,"Les codes par d\xe9faut fournis avec les yubikeys sont :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"code PIN : 123456"),(0,i.kt)("li",{parentName:"ul"},"code admin PIN : 12345678")),(0,i.kt)("p",null,"Nous allons changer ces codes par d\xe9faut :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"gpg/carte> passwd\ngpg: carte OpenPGP n\xba D2760001240103040006181585420000 d\xe9tect\xe9e\n\n1 - change PIN\n2 - unblock PIN\n3 - change Admin PIN\n4 - set the Reset Code\nQ - quit\n\nQuel est votre choix ?\n")),(0,i.kt)("p",null,"Saisir 1 pour modifier le code PIN, puis saisir le nouveau code choisi dans les 2 fen\xeatres qui s'affichent."),(0,i.kt)("p",null,"L'affichage revient au menu :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"1 - change PIN\n2 - unblock PIN\n3 - change Admin PIN\n4 - set the Reset Code\nQ - quit\n\nQuel est votre choix ?\n")),(0,i.kt)("p",null,"Saisir 3 pour modifier le code admin PIN, puis saisir le nouveau code choisi dans les 2 fen\xeatres qui s'affichent."),(0,i.kt)("p",null,"L'affichage revient au menu :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"1 - change PIN\n2 - unblock PIN\n3 - change Admin PIN\n4 - set the Reset Code\nQ - quit\n\nQuel est votre choix ?\n")),(0,i.kt)("p",null,"Saisir q pour sortir du menu."),(0,i.kt)("h3",{id:"modifier-les-attributs-de-cl\xe9"},(0,i.kt)("strong",{parentName:"h3"},"Modifier les attributs de cl\xe9")),(0,i.kt)("p",null,"On va modifier les attributs de la Yubikey pour s'assurer d'utiliser les types de cl\xe9s les plus robustes disponibles : type RSA de taille 4096 bits."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"gpg/card> key-attr\nChanging card key attribute for: Signature key\nPlease select what kind of key you want:\n   (1) RSA\n   (2) ECC\nYour selection? 1\nWhat keysize do you want? (2048) 4096\nThe card will now be re-configured to generate a key of 4096 bits\nChanging card key attribute for: Encryption key\nPlease select what kind of key you want:\n   (1) RSA\n   (2) ECC\nYour selection? 1\nWhat keysize do you want? (2048) 4096\nThe card will now be re-configured to generate a key of 4096 bits\nChanging card key attribute for: Authentication key\nPlease select what kind of key you want:\n   (1) RSA\n   (2) ECC\nYour selection? 1\nWhat keysize do you want? (2048) 4096\nThe card will now be re-configured to generate a key of 4096 bits\n")),(0,i.kt)("h3",{id:"cr\xe9er-sa-cl\xe9-pgp"},(0,i.kt)("strong",{parentName:"h3"},"Cr\xe9er sa cl\xe9 pgp")),(0,i.kt)("p",null,"On peut maintenant g\xe9n\xe9rer notre cl\xe9 PGP. Lorsque le prompt le demandera, on saisira les options suivantes :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Dur\xe9e de validit\xe9 de la cl\xe9 : 0 (pas d'expiration)"),(0,i.kt)("li",{parentName:"ul"},"identit\xe9 : saisir son nom, pr\xe9nom, adresse mail (sera utilis\xe9 pour identifier la cl\xe9)")),(0,i.kt)("p",null,"\u26a0\ufe0f une fois saisi 'O' pour Okay, la Yubikey peut mettre un certain temps \xe0 g\xe9n\xe9rer la cl\xe9 PGP, sans que le prompt r\xe9agisse. Il faut bien lui laisser le temps (quelques minutes) de terminer \u26a0\ufe0f"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"gpg/card> generate\nMake off-card backup of encryption key? (Y/n) n\n\nPlease note that the factory settings of the PINs are\n   PIN = '123456'     Admin PIN = '12345678'\nYou should change them using the command --change-pin\n\nPlease specify how long the key should be valid.\n         0 = key does not expire\n      <n>  = key expires in n days\n      <n>w = key expires in n weeks\n      <n>m = key expires in n months\n      <n>y = key expires in n years\nKey is valid for? (0) 3y\nKey expires at Jeu  6 avr 11:02:54 2028 CEST\nIs this correct? (y/N) y\n\nGnuPG needs to construct a user ID to identify your key.\n\nReal name: Pipo Bimbo\nEmail address: heroinedor@gmail.com\nComment:\nYou selected this USER-ID:\n    \"Pipo Bimbo <heroinedor@gmail.com>\"\n\nChange (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O\ngpg: key 109F2428DD97A597 marked as ultimately trusted\ngpg: revocation certificate stored as 'C:/Users/you/AppData/Roaming/gnupg/openpgp-revocs.d\\2F28DCB202028A5A2FE5A45D109F2428DD97A597.rev'\npublic and secret key created and signed.\n")),(0,i.kt)("p",null,"Normalement quand on a plusieurs Yubikey, on en utilise une pour stocker sa cl\xe9 primaire et une autre pour stocker les sous-cl\xe9s.\nDans notre cas en l'absence (temporaire) de Yubikey suppl\xe9mentaire, on se contentera de ne g\xe9n\xe9rer qu'une seule cl\xe9 PGP et de l'utiliser pour la suite du processus."),(0,i.kt)("h3",{id:"v\xe9rifier-sa-cl\xe9-pgp"},(0,i.kt)("strong",{parentName:"h3"},"V\xe9rifier sa cl\xe9 pgp")),(0,i.kt)("p",null,"Une fois la cr\xe9ation termin\xe9e, quitter le programme et le relancer. On peut ainsi v\xe9rifier la pr\xe9sence de la cl\xe9 sur la yubikey"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"gpg/carte> list\n\nReader ...........: Yubico YubiKey OTP FIDO CCID 00 00\nApplication ID ...: D2760001240103040006181585420000\nApplication type .: OpenPGP\nVersion ..........: 3.4\nManufacturer .....: Yubico\nSerial number ....: 18158542\nName of cardholder: [non positionn\xe9]\nLanguage prefs ...: [non positionn\xe9]\nSalutation .......:\nURL of public key : [non positionn\xe9]\nLogin data .......: [non positionn\xe9]\nSignature PIN ....: non forc\xe9\nKey attributes ...: rsa4096 rsa4096 rsa4096\nMax. PIN lengths .: 127 127 127\nPIN retry counter : 3 0 3\nSignature counter : 7\nKDF setting ......: off\nSignature key ....: 35FC 4FCA 4887 7127 E7F0  B29D 2FA2 7903 9EFA 1679\n      created ....: 2024-09-18 14:19:38\nEncryption key....: EE57 8EB2 6193 F607 A841  125A 220B 2314 5967 916F\n      created ....: 2024-09-18 14:19:38\nAuthentication key: A248 2E3B 8E7A 1722 A310  6B39 5FCA 9BBB CAC3 ABE5\n      created ....: 2024-09-18 14:19:38\nGeneral key info..:\npub  rsa4096/2FA279039EFA1679 2024-09-18 Pipo Bimbo <heroinedor@gmail.com>\nsec>  rsa4096/2FA279039EFA1679  cr\xe9\xe9 : 2024-09-18  expire : jamais\n                                n\xba de carte : 0006 18158542\n")),(0,i.kt)("p",null,"Noter l'indicatif de cl\xe9 (key handle), ici le : 2FA279039EFA1679\nIl servira dans la suite du processus"),(0,i.kt)("h3",{id:"exporter-sa-cl\xe9-publique-pgp"},(0,i.kt)("strong",{parentName:"h3"},"Exporter sa cl\xe9 publique pgp")),(0,i.kt)("p",null,"Afin de pouvoir uploader la cl\xe9 publique chez Github, il faut d'abord l'exporter :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gpg --armor --output yubikey_gpg_public.asc --export heroinedor@gmail.com\n")),(0,i.kt)("p",null,"On peut retrouver la cl\xe9 publique dans le fichier ainsi export\xe9"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat yubikey_gpg_public.asc\n-----BEGIN PGP PUBLIC KEY BLOCK-----\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n-----END PGP PUBLIC KEY BLOCK-----\n")),(0,i.kt)("h3",{id:"importer-sa-cl\xe9-publique-pgp-dans-github"},(0,i.kt)("strong",{parentName:"h3"},"Importer sa cl\xe9 publique pgp dans Github")),(0,i.kt)("p",null,'Le contenu de cette cl\xe9 (y compris les lignes ----BEGIN/END----) sont \xe0 importer dans le compte Github via le menu "settings"/"SSH and GPG Keys"'),(0,i.kt)("p",null,"Suivre cette documentation pour y parvenir : ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account"},"https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account")),(0,i.kt)("h3",{id:"configurer-git-pour-la-signature-\xe9lectronique"},(0,i.kt)("strong",{parentName:"h3"},"Configurer Git pour la signature \xe9lectronique")),(0,i.kt)("p",null,"\xc0 noter que comme pour toute configuration Git, elle peut \xeatre effectu\xe9e :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"au niveau de l'installation globale sur la machine en rajoutant \xe0 la ligne de commande ",(0,i.kt)("inlineCode",{parentName:"li"},"-global")),(0,i.kt)("li",{parentName:"ul"},"ou au niveau du d\xe9p\xf4t en rajoutant \xe0 la ligne de commande ",(0,i.kt)("inlineCode",{parentName:"li"},"-local"))),(0,i.kt)("p",null,"Indiquer \xe0 Git l'indicatif de cl\xe9 (key handle r\xe9cup\xe9r\xe9 au chapitre v\xe9rifier sa cl\xe9 pgp) \xe0 utiliser :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git config --global user.signingKey 2FA279039EFA1679\n")),(0,i.kt)("p",null,"Indiquer aussi \xe0 Git d'utiliser la signature automatique afin de n'avoir pas \xe0 le sp\xe9cifier \xe0 chaque commit"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git config --global commit.gpgsign true\n")),(0,i.kt)("p",null,"Et enfin, indiquer \xe0 Git quel programme PGP utiliser"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Linux")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git config --global gpg.program gpg2\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"macOS")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git config --global gpg.program gpg\n")),(0,i.kt)("h3",{id:"effectuer-son-premier-commit-git-sign\xe9"},(0,i.kt)("strong",{parentName:"h3"},"Effectuer son premier commit Git Sign\xe9")),(0,i.kt)("p",null,"Si tout s'est bien pass\xe9, il suffit maintenant d'effectuer un commit via Git pour que la signature soit automatiquement ajout\xe9e :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'$ git commit -m "signature test"\n[main 68e204c] signature test\n 1 file changed, 2 insertions(+)\n')),(0,i.kt)("p",null,"La pr\xe9sence de la signature peut \xeatre v\xe9rifi\xe9e ainsi :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ git log --show-signature\ncommit 68e204c945a95a2d8970a19552fdebcfdbb41864 (HEAD -> main)\ngpg: Signature faite le lun. 23 sept. 2024 17:14:44 CEST\ngpg:                avec la clef RSA 35FC4FCA48877127E7F0B29D2FA279039EFA1679\ngpg: Bonne signature de \xab Pipo Bimbo <heroinedor@gmail.com> \xbb [ultime]\nAuthor: Pipo Bimbo <heroinedor@gmail.com>\nDate:   Mon Sep 23 17:14:44 2024 +0200\n\n    signature test\n")),(0,i.kt)("p",null,"\ud83c\udf89 \ud83c\udf89 \ud83c\udf89 \ud83c\udf89"),(0,i.kt)("h2",{id:"aller-plus-loin"},(0,i.kt)("strong",{parentName:"h2"},"Aller plus loin")),(0,i.kt)("p",null,"Gestion des clefs SSH avec FIDO2 et la yubikey : ","[https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html]","(Securing SSH Authentication with FIDO2)\nSigner ses commits git avec la yubikey : ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/YubicoLabs/sign-git-commits-yubikey"},"https://github.com/YubicoLabs/sign-git-commits-yubikey")))}d.isMDXComponent=!0}}]);