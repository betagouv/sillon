"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[5605],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>v});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var u=a.createContext({}),l=function(e){var t=a.useContext(u),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},p=function(e){var t=l(e.components);return a.createElement(u.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,u=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=l(r),m=n,v=c["".concat(u,".").concat(m)]||c[m]||d[m]||i;return r?a.createElement(v,o(o({ref:t},p),{},{components:r})):a.createElement(v,o({ref:t},p))}));function v(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,o=new Array(i);o[0]=m;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s[c]="string"==typeof e?e:n,o[1]=s;for(var l=2;l<i;l++)o[l]=r[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},3284:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var a=r(7462),n=(r(7294),r(3905));const i={hide_table_of_contents:!0},o="Job queues / message broker",s={unversionedId:"database-for-everything/jobs",id:"database-for-everything/jobs",title:"Job queues / message broker",description:'Une "job queue" est utile :',source:"@site/docs/database-for-everything/jobs.mdx",sourceDirName:"database-for-everything",slug:"/database-for-everything/jobs",permalink:"/docs/database-for-everything/jobs",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/database-for-everything/jobs.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Stockage de fichiers (au revoir buckets S3)",permalink:"/docs/database-for-everything/file-storage"},next:{title:"Cache",permalink:"/docs/database-for-everything/cache"}},u={},l=[],p={toc:l},c="wrapper";function d(e){let{components:t,...r}=e;return(0,n.kt)(c,(0,a.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"job-queues--message-broker"},"Job queues / message broker"),(0,n.kt)("p",null,'Une "',(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Job_queue"},"job queue"),'" est utile :'),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Pour faire un travail en asynchrone (et ne pas bloquer la requ\xeate courante qui est synchrone) ;"),(0,n.kt)("li",{parentName:"ul"},"R\xe9partir la charge : les t\xe2ches en attente peuvent \xeatre ex\xe9cut\xe9es 1 par 1 ;"),(0,n.kt)("li",{parentName:"ul"},"En cas d'\xe9chec on peut automatiquement rejouer le \"job\" jusqu'\xe0 temps que \xe7a passe ;")),(0,n.kt)("admonition",{title:"Omission",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"Dans cette partie nous allons omettre le pattern d'",(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Event-driven_architecture"},"event sourcing")," et de ",(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Command%E2%80%93query_separation"},"CQRS"),' car nous estimons que les appliquer \xe0 tout son applicatif apporte une certaine complexit\xe9 dans le d\xe9veloppement. \xc9tant dans un monolithe avec un seul stockage, et pouvant b\xe9n\xe9ficier de transactions SQL, vous devriez pouvoir passer outre (et donc nous ne parlerons dans la suite de "job queue", pas de "message broker").')),(0,n.kt)("p",null,"Il ne faut pas essayer de tout garantir avec asynchronisme, vous risqueriez de complexifier votre outil (et donc sa phase de d\xe9bogage). Voici quelques cas concrets :"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Quand l'utilisateur envoie un formulaire, aucune raison de mettre cette action dans une file d'attente pour modifier la base de donn\xe9es, si quelque chose \xe9choue il est acceptable que l'utilisateur re\xe7oive une erreur serveur afin de retenter ;"),(0,n.kt)("li",{parentName:"ul"},'Si vous devez faire une action m\xe9tier sensible comme cr\xe9er une transaction financi\xe8re chez un partenaire, en faire un "job" permettra de vous garantir que si votre partenaire est hors service, la transaction sera quand m\xeame cr\xe9\xe9e une fois que le partenaire sera de nouveau sur pieds ;'),(0,n.kt)("li",{parentName:"ul"},'Si mes partenaires peuvent me notifier d\'\xe9v\xe9nements m\xe9tiers indispensables \xe0 mon produit, il vaut mieux mettre le payload HTTP re\xe7u (souvent du JSON) directement dans une "job queue" m\xeame si vous le traitez imm\xe9diatement. Cela permettra :',(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},'Si vous avez une erreur temporaire, de pouvoir rejouer le webhook (tr\xe8s souvent les partenaires n\'ont pas de logique de "retry" pouss\xe9e donc il serait risqu\xe9 de se reposer sur eux) ;'),(0,n.kt)("li",{parentName:"ol"},"Si jamais votre partenaire change de format de donn\xe9es dans son payload, on sait d'avance que cela ne passerait pas de votre c\xf4t\xe9 ",(0,n.kt)("a",{parentName:"li",href:"/docs/client-server-communication/input-validation"},"car vous validez la donn\xe9e en entr\xe9e"),", il vaut mieux avoir le payload complet utilis\xe9 pour investiguer et savoir ce qu'il faut ajuster.")))),(0,n.kt)("p",null,"Nous pr\xe9conisons d'utiliser la librairie ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/timgit/pg-boss"},(0,n.kt)("inlineCode",{parentName:"a"},"pg-boss")),' en lieu de place d\'outils d\xe9di\xe9s comme "Redis Pub/Sub", Kafka (\u2026). Elle va savoir reproduire toute la logique des "job queues" en ayant quelques tables dans votre base de donn\xe9es. De plus :'),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Elle fait tr\xe8s bien le travail pour un usage normal ;"),(0,n.kt)("li",{parentName:"ul"},"Cela vous \xe9vitera de devoir le maintenir un outil stateful suppl\xe9mentaire ;"),(0,n.kt)("li",{parentName:"ul"},"Cela vous \xe9vitera de devoir d\xe9boguer via plusieurs outils \xe0 la fois ;"),(0,n.kt)("li",{parentName:"ul"},"Quand vous ferez un ",(0,n.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Backup"},"backup"),' ou un "restore" de votre base de donn\xe9es, les \xe9v\xe9nements seront synchronis\xe9s avec l\'\xe9tat global des donn\xe9es de votre produit.')),(0,n.kt)("admonition",{title:"Informations annexes",type:"info"},(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"pg-boss")," sait g\xe9rer les cron jobs, donc plut\xf4t que d'utiliser une fonctionnalit\xe9 propre \xe0 votre provider (qui ne garantit souvent pas l'unicit\xe9 de l'op\xe9ration), vous pouvez vous en servir ;"),(0,n.kt)("li",{parentName:"ul"},"Next.js ne permet ",(0,n.kt)("em",{parentName:"li"},"pour l'instant")," pas de lancer directement des processus asynchrones (il faudrait modifier le serveur web mais on perdrait l'optimisation qu'ils ont fait). Notre approche est d'utiliser un endpoint ",(0,n.kt)("inlineCode",{parentName:"li"},"/init")," qui sera appel\xe9 au lancement du serveur ;"),(0,n.kt)("li",{parentName:"ul"},"\xc0 vous de choisir votre strat\xe9gie de rejeu en fonction de la criticit\xe9 du job :",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"N'oubliez pas de sp\xe9cifier un maximum de rejeux pour un job car certains ne passeront jamais et il serait dommage de flooder votre syst\xe8me ou vos partenaires (sans jamais tra\xeeter les jobs suivants, qui eux, peuvent peut-\xeatre passer) ;"),(0,n.kt)("li",{parentName:"ul"},"Vous pouvez vous reposer sur ",(0,n.kt)("a",{parentName:"li",href:"/docs/monitoring/"},"Sentry")," pour \xeatre notifi\xe9 d'un job qui est abandonn\xe9 afin que vous puissiez investiguer et tenter de le rejouer manuellement."))))))}d.isMDXComponent=!0}}]);