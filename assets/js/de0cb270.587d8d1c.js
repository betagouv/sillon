"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[1826],{3905:(e,r,n)=>{n.d(r,{Zo:()=>p,kt:()=>f});var t=n(7294);function i(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function s(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?s(Object(n),!0).forEach((function(r){i(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}function a(e,r){if(null==e)return{};var n,t,i=function(e,r){if(null==e)return{};var n,t,i={},s=Object.keys(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||(i[n]=e[n]);return i}(e,r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=t.createContext({}),u=function(e){var r=t.useContext(l),n=r;return e&&(n="function"==typeof e?e(r):o(o({},r),e)),n},p=function(e){var r=u(e.components);return t.createElement(l.Provider,{value:r},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var r=e.children;return t.createElement(t.Fragment,{},r)}},m=t.forwardRef((function(e,r){var n=e.components,i=e.mdxType,s=e.originalType,l=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),d=u(n),m=i,f=d["".concat(l,".").concat(m)]||d[m]||c[m]||s;return n?t.createElement(f,o(o({ref:r},p),{},{components:n})):t.createElement(f,o({ref:r},p))}));function f(e,r){var n=arguments,i=r&&r.mdxType;if("string"==typeof e||i){var s=n.length,o=new Array(s);o[0]=m;var a={};for(var l in r)hasOwnProperty.call(r,l)&&(a[l]=r[l]);a.originalType=e,a[d]="string"==typeof e?e:i,o[1]=a;for(var u=2;u<s;u++)o[u]=n[u];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4009:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>s,metadata:()=>a,toc:()=>u});var t=n(7462),i=(n(7294),n(3905));const s={hide_table_of_contents:!0},o="La gestion d'erreurs",a={unversionedId:"error-handling/index",id:"error-handling/index",title:"La gestion d'erreurs",description:"Les diff\xe9rencier",source:"@site/docs/error-handling/index.mdx",sourceDirName:"error-handling",slug:"/error-handling/",permalink:"/docs/error-handling/",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/error-handling/index.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Les tests et la limite du mock",permalink:"/docs/tests-and-the-mock-limit/"},next:{title:"Backups",permalink:"/docs/backups"}},l={},u=[{value:"Les diff\xe9rencier",id:"les-diff\xe9rencier",level:2},{value:"L&#39;impl\xe9mentation",id:"limpl\xe9mentation",level:2},{value:"Particularit\xe9 des validations de donn\xe9es entrantes",id:"particularit\xe9-des-validations-de-donn\xe9es-entrantes",level:2}],p={toc:u},d="wrapper";function c(e){let{components:r,...n}=e;return(0,i.kt)(d,(0,t.Z)({},p,n,{components:r,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"la-gestion-derreurs"},"La gestion d'erreurs"),(0,i.kt)("h2",{id:"les-diff\xe9rencier"},"Les diff\xe9rencier"),(0,i.kt)("p",null,"Pour vous simplifier la t\xe2che au cours du d\xe9veloppement et pour la maintenance de votre applicatif il est int\xe9ressant de diff\xe9rencier :"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Les erreurs qui sont inattendues dans votre applicatif et qui doivent \xeatre investigu\xe9es (ci-apr\xe8s la famille des ",(0,i.kt)("inlineCode",{parentName:"p"},"UnexpectedError"),"), par exemple :"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"La connexion \xe0 la base de donn\xe9es ne marche pas ;"),(0,i.kt)("li",{parentName:"ul"},"Une librairie renvoie une erreur inattendue ;"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Les erreurs qui peuvent \xeatre consid\xe9r\xe9es comme "normales" (ci-apr\xe8s la famille des ',(0,i.kt)("inlineCode",{parentName:"p"},"BusinessError"),"), par exemple :"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Un utilisateur a rentr\xe9 dans son formulaire des donn\xe9es invalides ;"),(0,i.kt)("li",{parentName:"ul"},"Un utilisateur a d\xe9pass\xe9 son nombre de requ\xeates autoris\xe9es par minute.")))),(0,i.kt)("p",null,"Il est pr\xe9f\xe9rable de tenir inform\xe9 l'utilisateur de l'erreur \xe0 laquelle il fait face afin qu'il sache s'il peut retenter plus tard, s'il doit changer sa saisie, ou s'il doit contacter le support. Pour autant il est tr\xe8s difficile de savoir si les erreurs remont\xe9es par vos d\xe9pendences ne vont pas laisser fuiter des informations sensibles (imaginons l'exemple exag\xe9r\xe9 d'une librairie pour comparer des hashs de mots de passe qui aurait une erreur et mentionnerait les deux entr\xe9es pour aider \xe0 d\xe9bugguer). De plus, ces derni\xe8res sont souvent formatt\xe9es avec du contenu technique ",(0,i.kt)("strong",{parentName:"p"},"et")," en anglais, ce qui r\xe9duit son int\xe9r\xeat pour les utilisateurs finaux."),(0,i.kt)("p",null,"En diff\xe9renciant les 2 types d'erreurs, vous pourriez positionner \xe0 chaque entr\xe9e de votre applicatif (endpoints...) un middleware pour garantir que toute erreur qui ne serait pas pr\xe9formatt\xe9e explicitement par votre projet (les fameuses ",(0,i.kt)("inlineCode",{parentName:"p"},"BusinessError"),") ne sera jamais transmise \xe0 l'utilisateur (que ce soit sur le r\xe9seau si l'erreur vient du backend, ou affich\xe9e \xe0 l'utilisateur si l'erreur vient du frontend). L'applicatif renverra juste une ",(0,i.kt)("inlineCode",{parentName:"p"},"UnexpectedError")," appropri\xe9e au contexte."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Le b\xe9n\xe9fice de cette diff\xe9renciation va aussi \xeatre dans ",(0,i.kt)("a",{parentName:"p",href:"/docs/monitoring/for-technical-needs"},"la remont\xe9e d'erreurs \xe0 des outils de monitoring"),". Vous n'aurez plus qu'\xe0 seulement remonter les erreurs inattendues afin de recevoir des notifications pertinentes."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("em",{parentName:"p"},"Il se peut que l'erreur remont\xe9e soit finalement une erreur acceptable que vous n'aviez pas prise en compte auparavant, il ne vous reste plus qu'\xe0 lui cr\xe9er ",(0,i.kt)("inlineCode",{parentName:"em"},"try/catch")," proprement ou \xe0 la transformer ",(0,i.kt)("inlineCode",{parentName:"em"},"BusinessError")," si appropri\xe9."))),(0,i.kt)("h2",{id:"limpl\xe9mentation"},"L'impl\xe9mentation"),(0,i.kt)("p",null,"Que ce soit pour les ",(0,i.kt)("inlineCode",{parentName:"p"},"BusinessError")," ou les ",(0,i.kt)("inlineCode",{parentName:"p"},"UnexpectedError")," nous allons vous montrer des structures simples qui r\xe9pondent \xe0 la majorit\xe9 des cas d'utilisation. Normalement la minorit\xe9 non-comprise devrait juste \xeatre li\xe9e \xe0 la validation des donn\xe9es entrantes (nous d\xe9taillons ce point un peu plus bas)."),(0,i.kt)("p",null,"L'id\xe9e est :"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"D'avoir une propri\xe9t\xe9 ",(0,i.kt)("inlineCode",{parentName:"li"},"code")," unique qui repr\xe9sente l'erreur afin de pouvoir faire des conditions dessus si n\xe9cessaire, et qui servira aussi d'identifiant de cl\xe9 de traduction si vous traduisez les erreurs ;"),(0,i.kt)("li",{parentName:"ol"},"D'avoir une propri\xe9t\xe9 ",(0,i.kt)("inlineCode",{parentName:"li"},"message")," pour que dans n'importe quel contexte de lecture (logs...) on puisse humainement comprendre ce qu'il s'est pass\xe9 ;"),(0,i.kt)("li",{parentName:"ol"},"De pouvoir encoder/d\xe9coder l'erreur afin de la transmettre sur le r\xe9seau (une erreur backend peut ainsi \xeatre proprement affich\xe9 sur le frontend).")),(0,i.kt)("p",null,"Afin de garder une logique de r\xe9utilisation et d'extensibilit\xe9, nous utilisons des classes. Ainsi, vous pourriez impl\xe9menter des structures d'erreurs avec plus de propri\xe9t\xe9s en repartant des existantes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export class CustomError extends Error {\n  public constructor(public readonly code: string, message: string = '') {\n    super(message);\n  }\n\n  public json(): object {\n    return {\n      code: this.code,\n      message: this.message,\n    };\n  }\n}\n\nexport class UnexpectedError extends CustomError {}\n\nexport class BusinessError extends CustomError {}\n")),(0,i.kt)("p",null,"Ainsi vous pouvez d\xe9finir dans votre applicatif des singletons d'erreurs tels que :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export const internalServerErrorError = new UnexpectedError('internalServerError', 'internal server error');\nexport const userNotFoundError = new BusinessError('userNotFound', 'user not found');\n")),(0,i.kt)("p",null,"Au moment d'utiliser une erreur il suffirait d'utiliser ",(0,i.kt)("inlineCode",{parentName:"p"},"throw userNotFoundError;"),", et si vous utilisez des ",(0,i.kt)("inlineCode",{parentName:"p"},"try/catch")," pour avoir des cas sp\xe9cifiques \xe0 des niveaux sup\xe9rieures vous seriez en mesure de faire :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"try {\n  // ...\n} catch (error) {\n  if (error === userNotFoundError) {\n    // Specific handling\n  } else {\n    throw error;\n  }\n}\n")),(0,i.kt)("p",null,"Pour ce qui est des middlewares au niveau des endpoints de votre applicatif vous pourriez avoir :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"try {\n  myEndpointController();\n} catch (error) {\n  // Formatting so frontend can handle it properly\n  // Note that errors not being business ones are masked to the frontend\n  res.json({\n    customError: error instanceof CustomError ? error.json() : internalServerErrorError.json(),\n  });\n}\n")),(0,i.kt)("p",null,"Pour ce qui est du frontend :"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Soit votre erreur a \xe9t\xe9 \xe9mise par le frontend lui-m\xeame et c'est donc une instance de ",(0,i.kt)("inlineCode",{parentName:"li"},"CustomError"),", que vous pouvez facilement l'analyser avec un ",(0,i.kt)("inlineCode",{parentName:"li"},"try/catch")," ;"),(0,i.kt)("li",{parentName:"ol"},"Soit l'erreur vient du backend, et a \xe9t\xe9 encod\xe9e pour \xeatre transport\xe9e sur le r\xe9seau (vous devez donc la d\xe9coder pour la manipuler).")),(0,i.kt)("p",null,"Par exemple pour la (2) vous pourriez faire :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"const response = await fetch('https://...');\n\nif (response.status !== 200) {\n  const errorResponse = await response.json();\n\n  if (!!errorResponse.customError) {\n    throw new CustomError(errorResponse.customError.code, errorResponse.customError.message);\n  } else {\n    console.error(errorResponse);\n\n    throw internalServerErrorError;\n  }\n}\n")),(0,i.kt)("p",null,"Dans l'id\xe9e, pour chaque appel de votre client API vous essayez d'intercepter une erreur au niveau de l'instruction. S'il en existe une vous affichez un composant qui affiche l'erreur \xe0 l'utilisateur (par exemple ",(0,i.kt)("inlineCode",{parentName:"p"},"<ErrorAlert error={error}>"),"). Cela vous permet d'ajuster l'affichage de l'erreur en fonction de la structure de la page."),(0,i.kt)("h2",{id:"particularit\xe9-des-validations-de-donn\xe9es-entrantes"},"Particularit\xe9 des validations de donn\xe9es entrantes"),(0,i.kt)("p",null,"Dans les pr\xe9c\xe9dents chapitres nous vous avons pr\xe9sent\xe9 ",(0,i.kt)("inlineCode",{parentName:"p"},"zod")," pour valider les entr\xe9es utilisateurs. Du fait de sa complexit\xe9, les m\xe9tadonn\xe9es de ces erreurs (les ",(0,i.kt)("inlineCode",{parentName:"p"},"ZodError"),") ne peuvent pas tenir dans une structure avec juste un ",(0,i.kt)("inlineCode",{parentName:"p"},"code")," et un ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," car elles peuvent indiquer qu'il y a plusieurs erreurs, quels champs sont impliqu\xe9s, et y apposer des param\xe8tres informatifs (longueur maximale d'une cha\xeene de caract\xe8res...). Il ne sert \xe0 rien d'essayer de retrouver une structure g\xe9n\xe9rique \xe0 toutes les librairies de validation car chacune est trop sp\xe9cifique. Nous vous conseillons d'adopter pleinement la structure de votre librairie et d'utiliser la m\xeame sur le frontend et backend ",(0,i.kt)("em",{parentName:"p"},"(possible si vous utilisez le m\xeame langage)"),"."),(0,i.kt)("p",null,"Pour reprendre notre exemple des ",(0,i.kt)("inlineCode",{parentName:"p"},"CustomError")," qui sont formatt\xe9es au moment d'\xeatre renvoy\xe9es sur le r\xe9seau, nous aurions juste \xe0 ajouter une condition :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { ZodError } from 'zod';\n\ntry {\n  myEndpointController();\n} catch (error) {\n  const isZodError = error instanceof ZodError;\n\n  res.json({\n    zodError: isZodError ? error.issues : null, // zod `issues` property is the only thing helpful for any client to handle the error\n    customError: !isZodError ? (error instanceof CustomError ? error.json() : internalServerErrorError.json()) : null,\n  });\n}\n")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},'Pour simplifier la phase de "parsing" sur le frontend, nous dissocions la propri\xe9t\xe9 ',(0,i.kt)("inlineCode",{parentName:"p"},"zodError")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"customError"),". Car votre librairie de validation pourrait tr\xe8s bien avoir une structure d'erreur qui soit similaire \xe0 celle de notre ",(0,i.kt)("inlineCode",{parentName:"p"},"CustomError"),", complexifiant la diff\xe9renciation des deux.")))}c.isMDXComponent=!0}}]);