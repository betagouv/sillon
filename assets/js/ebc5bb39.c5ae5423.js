"use strict";(self.webpackChunksillon=self.webpackChunksillon||[]).push([[4259],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>f});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var u=r.createContext({}),c=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},l=function(e){var t=c(e.components);return r.createElement(u.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,u=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=i,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||a;return n?r.createElement(f,o(o({ref:t},l),{},{components:n})):r.createElement(f,o({ref:t},l))}));function f(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=m;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s[p]="string"==typeof e?e:i,o[1]=s;for(var c=2;c<a;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9710:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var r=n(7462),i=(n(7294),n(3905));const a={hide_table_of_contents:!0},o="Validation des donn\xe9es entrantes",s={unversionedId:"client-server-communication/input-validation",id:"client-server-communication/input-validation",title:"Validation des donn\xe9es entrantes",description:"Que ce soit sur vos endpoints tRPC ou sur un endpoint \xe0 part dans Next.js pour recevoir des webhooks, la devise est de toujours valider les donn\xe9es entrantes.",source:"@site/docs/client-server-communication/input-validation.mdx",sourceDirName:"client-server-communication",slug:"/client-server-communication/input-validation",permalink:"/docs/client-server-communication/input-validation",draft:!1,editUrl:"https://github.com/betagouv/sillon/tree/main/docs/client-server-communication/input-validation.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Permettre l'\xe9volutivit\xe9",permalink:"/docs/client-server-communication/allow-evolutivity"},next:{title:"Pr\xe9f\xe9rez l'API \xe0 la mise en cache frontend",permalink:"/docs/client-server-communication/prefer-api-to-frontend-caching"}},u={},c=[],l={toc:c},p="wrapper";function d(e){let{components:t,...n}=e;return(0,i.kt)(p,(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"validation-des-donn\xe9es-entrantes"},"Validation des donn\xe9es entrantes"),(0,i.kt)("p",null,"Que ce soit sur vos endpoints tRPC ou sur un endpoint \xe0 part dans Next.js pour recevoir des ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Webhook"},"webhooks"),", la devise est de ",(0,i.kt)("strong",{parentName:"p"},"toujours valider les donn\xe9es entrantes"),"."),(0,i.kt)("p",null,"Nous utilisons ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/colinhacks/zod"},(0,i.kt)("inlineCode",{parentName:"a"},"zod"))," pour faire la validation au moment du runtime (quand les types ne peuvent \xeatre garantis sur les donn\xe9es entrantes). Cela nous permet une certaine flexibilit\xe9 puisqu'il peut servir \xe0 la validation d'entr\xe9e d'un endpoint mais aussi pour formater une structure m\xe9tier (dans le cas o\xf9 vous voulez que \xe7a \xe9mette une erreur si la structure r\xe9cup\xe9r\xe9e depuis une base de donn\xe9es est mal format\xe9e par exemple)."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Une pratique peut \xeatre de d\xe9finir vos structures m\xe9tiers avec ",(0,i.kt)("inlineCode",{parentName:"li"},"zod"),' puisque les types peuvent \xeatre "',(0,i.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Type_inference"},"inf\xe9r\xe9s"),'" ;'),(0,i.kt)("li",{parentName:"ul"},"zod est nativement support\xe9 par tRPC, donc vous n'avez qu'\xe0 mettre votre structure ",(0,i.kt)("inlineCode",{parentName:"li"},"input")," au niveau du endpoint ;"),(0,i.kt)("li",{parentName:"ul"},"zod peut s'utiliser c\xf4t\xe9 frontend avec ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/react-hook-form/react-hook-form"},(0,i.kt)("inlineCode",{parentName:"a"},"react-hook-form"))," afin de faire des validations sans m\xeame contacter le serveur. Ce qui est pratique dans notre cas c'est que la m\xeame structure de validation est utilis\xe9e dans les 2 mondes (avec ces textes d'erreurs qui peuvent \xeatre personnalis\xe9s).")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:"title=\"entities/agent.tsx | D\xe9claration d'une structure d'entit\xe9\" showLineNumbers",title:'"entities/agent.tsx',"|":!0,"D\xe9claration":!0,"d'une":!0,structure:!0,"d'entit\xe9\"":!0,showLineNumbers:!0},"import z from 'zod';\n\nimport { UserSchema } from './user';\n\nexport const AgentSchema = z\n  .object({\n    id: z.string().uuid(),\n    userId: z.string().uuid(),\n    authorityId: z.string().uuid(),\n    firstname: UserSchema.shape.firstname,\n    lastname: UserSchema.shape.lastname,\n    email: UserSchema.shape.email,\n    profilePicture: UserSchema.shape.profilePicture,\n    isMainAgent: z.boolean(),\n    createdAt: z.date(),\n    updatedAt: z.date(),\n    deletedAt: z.date().nullable(),\n  })\n  .strict();\nexport type AgentSchemaType = z.infer<typeof AgentSchema>;\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:"title=\"actions/agent.tsx | Validation d'une mutation avec les propri\xe9t\xe9s d'entit\xe9s existantes\" showLineNumbers",title:'"actions/agent.tsx',"|":!0,Validation:!0,"d'une":!0,mutation:!0,avec:!0,les:!0,"propri\xe9t\xe9s":!0,"d'entit\xe9s":!0,'existantes"':!0,showLineNumbers:!0},"import { AgentSchema } from '@mediature/main/src/models/entities/agent';\nimport { AuthoritySchema } from '@mediature/main/src/models/entities/authority';\nimport { UserSchema } from '@mediature/main/src/models/entities/user';\nimport z from 'zod';\n\nexport const AddAgentSchema = z\n  .object({\n    userId: UserSchema.shape.id,\n    authorityId: AgentSchema.shape.authorityId,\n    grantMainAgent: z.boolean(),\n  })\n  .strict();\nexport type AddAgentSchemaType = z.infer<typeof AddAgentSchema>;\n")))}d.isMDXComponent=!0}}]);