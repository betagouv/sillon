---
hide_table_of_contents: true
---

# Connection SSH et signature de commit avec une cl√© de s√©curit√©

Comme indiqu√© dans la section 2FA / Security keys, les cl√©s de s√©curit√©s (comme les Yubikey) sont des clefs USB/dongles utilis√©s principalement pour s√©curiser l'authentification des utilisateurs √† leur compte, mais pas seulement.
Elles peuvent aussi servir √† authentifier les commits git.

Pour la suite de cette documentation Le type de cl√© (Yubikey USB-C, USB-A, etc.) n'est pas important. En revanche, nous travaillerons avec cl√© compatible FIDO2 et PGP.
Normalement (√† par l'utilitaire ykman), ces commandes fonctionnent pour toutes les cl√©s compatibles FIDO2 (pour les acc√®s SSH/Passkeys) et carte √† puce (pour la partie PGP)

## **Installation**

Pour ce tutoriel, nous allons utilisez la bibiliotheque fido2 : [https://github.com/Yubico/libfido2?tab=readme-ov-file#installation](https://github.com/Yubico/libfido2?tab=readme-ov-file#installation)

> Il existe comme alternatice le Yubikey-manager si vous avez une Yubikey : la documentation pour l'installer : [https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html](https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html)
> Il existe aussi fido-manager.

### Initialiser une nouvell√© cl√©

La premi√®re chose √† faire, apr√®s avoir branch√© votre cl√©, est definir de d√©finir un code PIN.

Voici comment faire avec la libfido2 :

```
# fido2-token -L
DevSrvsID:876876876: vendor=0x1050, product=0x0407 (Yubico YubiKey OTP+FIDO+CCID)
```

Copier la partie `DevSrvsID:876876876` (cela peut √™tre `/dev/hidraw*` sous linux ou `DevSrvsID:******` sous max).

```
# fido2-token -S DevSrvsID:876876876
Enter new PIN for DevSrvsID:876876876:
Enter same PIN again:
```

> Mettez un code PIN √† 6 chiffres (ou plus si vous le souhaitez)

## **Authentification par passkeys**

## **Gestion des clefs SSH**

FIDO2 est un standard d'authentification sans mot de passe qui utilise la cryptographie √† cl√© publique pour s√©curiser les connexions en ligne.
Fido2 fonctionne avec SSH de la mani√®re suivante :

- la clef publique est partag√©e avec l'h√¥te distant
- la clef priv√©e n'est pas r√©ellement stock√©e sur la machine locale : le fichier de clef priv√© contient un ID qui r√©f√©rence la clef priv√©e stock√©e sur la yubikey

### **Cr√©ation**

La cr√©ation d'une clef se fait via l'utilitaire ssh-keygen :

```bash
ssh-keygen -t ed25519-sk -O resident -O application=ssh:github
```

Au moment o√π cette commande est valid√©e, le code PIN de la yubikey sera demand√©.
On vous demande o√π stocker la cl√©, choisissez le r√©pertoire `~/.ssh/id_ed25519_sk_rk_github`.
Vous n'avez pas besoin de mettre une passphrase.

> L'option "-O resident" sp√©cifie que la clef priv√©e est stock√©e dans la yubikey.
> L'option "-O application=ssh:github" indique que la clef ssh g√©n√©r√©e aura pour ID "ssh:github" dans la yubikey.
> Dans le cas o√π on doit g√©n√©rer une autre clef SSH, on lui sp√©cifiera un autre nom.

Dans la commande suivante, elle aura pour ID "ssh:infra-prod" pour se connecter √† votre infra (si vous avez besoin).

```bash
ssh-keygen -t ed25519-sk -O resident -O application=ssh:infra-prod
```

### **Visualisation avec la libfido2**

Pour visualiser les cl√©s pr√©c√©demment cr√©√©es saisir la commande suivante :

```bash
# fido2-token -L
DevSrvsID:876876876: vendor=0x1050, product=0x0407 (Yubico YubiKey OTP+FIDO+CCID)
# fido2-token -L -r DevSrvsID:876876876
Enter PIN for DevSrvsID:876876876:
00: QHqudhq!D767QDhnqiUDhQ8D9hqD8qhjd9HQJ8DJQ9Q= ssh:github
01: ds!qh!QSUNIDUIHqdjk465bU898DQBNJKQ898DS89Q8= ssh:infra-prod
```

On a bien deux clefs ssh r√©f√©renc√©es sous 2 ID diff√©rents.

#### Alternative sur une Yubikey

```bash
ykman fido credentials list
```

Apr√®s la saisie du code PIN, le r√©sultat pourra ressembler √† ceci :

```bash
Credential ID  RP ID       Username           Display name
a8f896e6...    ssh:github  openssh            openssh
e929dde6...    ssh:infra-prod    openssh            openssh
```

### **Import sur une machine**

Suite aux √©tapes pr√©c√©dentes, nous avons un couple de clefs priv√©e/publique install√©s sur la yubikey.
Voici comment faire pour importer ces clefs sur une machine :

```bash
cd ~/.ssh
ssh-keygen -K
```

Les clefs sont maintenant stock√©es dans le r√©pertoire ~/.ssh et peuvent √™tre list√©es via :

```bash
~/.ssh$ ls
id_ed25519_sk_rk_github
id_ed25519_sk_rk_github.pub
id_ed25519_sk_rk_infra-prod
id_ed25519_sk_rk_infra-prod.pub
```

### Ajout de la cl√© sur Github

Ajouter la cl√© publique (`~/.ssh/id_ed25519_sk_rk_github.pub`) sur Github : https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account
Vous devez l'ajouter comme une "authentication key".

### **Utilisation dans git**

Maintenant que nos clefs sont import√©es sur la machine, nous allons nous en servir pour nous connecter √† un d√©p√¥t github.
Pour cela, nous allons configurer le fichier .ssh/config

```bash
cd ~/.ssh/
nano config
```

Saisir dans l'√©diteur de texte (nano ou vim ou autre) le texte suivant :

```
Host github.com
  IdentityFile /home/USER/.ssh/id_ed25519_sk_rk_github
```

En rempla√ßant `USER` par le nom de l'utilisateur linux qui utilisera la clef.
Remplacer "id_ed25519_sk_rk_github" par le nom du fichier de clef priv√©e qui devra √™tre pr√©sent√©.

Vous pouvez tester que cela fonctionne avec la commande suivante :

```
# ssh git@github.com
```

Vous devez avoir le r√©sultat suivant :

```
Confirm user presence for key ED25519-SK SHA256:89798798798798797
User presence confirmed
PTY allocation request failed on channel 0
Hi johndoe! You've successfully authenticated, but GitHub does not provide shell access.
Connection to github.com closed.
```

√Ä noter que dans le cas o√π l'on a plusieurs clefs ssh pour se connecter √† plusieurs comptes github, on peut le sp√©cifier de mani√®re un peu diff√©rente :

- cr√©er le fichier /home/`USER` /config.d/config-github et saisir ce qui a √©t√© pr√©ciser au dessus
- au moment de la connexion, pr√©ciser dans la variable d'environnement GIT_SSH_COMMAND le fichier de config ssh √† utiliser :

```bash
GIT_SSH_COMMAND="ssh -F /home/`USER` /.ssh/config.d/config-github" git clone git@github.com:mon-orga/mon-repo.git
```

Vous voil√† pr√™t √† travailler avec votre d√©p√¥t git !

## **Signer ses commits avec une cl√© de s√©curit√© **

### Signer avec une cl√© SSH (version recommand√©)

Cr√©ation d'une clef SSH de signature se fait via l'utilitaire ssh-keygen :

```bash
ssh-keygen -t ed25519-sk -O resident -O application=ssh:git-sign
```

(Vous n'avez pas besoin de passphrase)
Vous pouvez sauvegarder ici : /home/USER/.ssh/id_ed25519_sk_rk_git-sign

#### Ajout de la cl√© sur Github

Ajouter la cl√© publique (`~/.ssh/id_ed25519_sk_rk_github.pub`) sur Github : https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account
Vous devez l'ajouter comme une "signing key".

#### Indiquer la cl√© SSH de signature √† Git

https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key#telling-git-about-your-ssh-key

```
git config --global gpg.format ssh
git config --global user.signingkey /home/USER/.ssh/id_ed25519_sk_rk_git-sign
```

Signer un premier commit

```
$ git commit -S -m "signature test"
```

La yubikey va clignoter, il faut la toucher.

Vous pouvez v√©rifier votre signature avec la commande suivante :

```bash
$ git log --show-signature
commit 68e204c945a95a2d8970a19552fdebcfdbb41864 (HEAD -> main)
gpg: Signature faite le lun. 23 sept. 2024 17:14:44 CEST
gpg:                avec la clef RSA 35FC4FCA48877127E7F0B29D2FA279039EFA1679
gpg: Bonne signature de ¬´ Pipo Bimbo <heroinedor@gmail.com> ¬ª [ultime]
Author: Pipo Bimbo <heroinedor@gmail.com>
Date:   Mon Sep 23 17:14:44 2024 +0200

    signature test
```

Activer la signature de tous les commits automatiquement dans tous les repos :

```
$ git config --global commit.gpgsign true
```

C'est bon pour la signature des commits avec votre cl√© SSH ! üéâ

### Installer et configurer GnuPG (version alternative)

Si vous n'avez pas choisi la signature de commit avec votre cl√© SSH, vous pouvez le faire avec OpenPGP.

OpenPGP est un standard utilis√© pour la manipulation des cl√©s cryptographiques. Son impl√©mentation principale est GNU Privacy Guard (gnupg).

Voici les proc√©dures d'installation en fonction de l'OS:

- **Linux** :

Installer les paquets suivant avec le package-manager (apt) : GPG, pcscd, scdaemon

```bash
$ sudo apt install pcscd gnupg2 scdaemon
```

- **macOS** :

Installation via homebrew

```bash
$ brew install gnupg
```

Puis installation de Pinentry

```bash
$ brew install pinentry-mac
```

Ajouter au fichier ~/.gnupg/gpg-agent.conf:

```bash
pinentry-program /usr/local/bin/pinentry-mac
```

Ajouter au fichier ~/.gnupg/scdaemon.conf :

```bash
disable-ccid
```

### **Test de l'installation**

Une fois cette installation termin√©e, on peut tester le bon fonctionnement de gpg en ins√©rant la Yubikey dans un port USB et en tapant :

```bash
$ gpg --card-status
```

Si ma carte est vierge alors devrait appara√Ætre le r√©sultat suivant :

```bash
Reader ...........: Yubico YubiKey OTP FIDO CCID 0
Application ID ...: D2760001240102010006078005150000
Version ..........: 2.1
Manufacturer .....: Yubico
Serial number ....: 07800515
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: not forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
```

### **Modifier les codes PIN et admin PIN**

Saisir dans un shell :

```bash
$ gpg --card-edit
```

‚Üí on se retrouve dans un prompt gpg/card

Saisir :

```bash
gpg/carte> admin
Les commandes d'administration sont permises
```

Les codes par d√©faut fournis avec les yubikeys sont :

- code PIN : 123456
- code admin PIN : 12345678

Nous allons changer ces codes par d√©faut :

```bash
gpg/carte> passwd
gpg: carte OpenPGP n¬∫ D2760001240103040006181585420000 d√©tect√©e

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir 1 pour modifier le code PIN, puis saisir le nouveau code choisi dans les 2 fen√™tres qui s'affichent.

L'affichage revient au menu :

```bash
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir 3 pour modifier le code admin PIN, puis saisir le nouveau code choisi dans les 2 fen√™tres qui s'affichent.

L'affichage revient au menu :

```bash
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir q pour sortir du menu.

### **Modifier les attributs de cl√©**

On va modifier les attributs de la Yubikey pour s'assurer d'utiliser les types de cl√©s les plus robustes disponibles : type RSA de taille 4096 bits.

```bash
gpg/card> key-attr
Changing card key attribute for: Signature key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
Changing card key attribute for: Encryption key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
Changing card key attribute for: Authentication key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
```

### **Cr√©er sa cl√© pgp**

On peut maintenant g√©n√©rer notre cl√© PGP. Lorsque le prompt le demandera, on saisira les options suivantes :

- Dur√©e de validit√© de la cl√© : 0 (pas d'expiration)
- identit√© : saisir son nom, pr√©nom, adresse mail (sera utilis√© pour identifier la cl√©)

‚ö†Ô∏è une fois saisi 'O' pour Okay, la Yubikey peut mettre un certain temps √† g√©n√©rer la cl√© PGP, sans que le prompt r√©agisse. Il faut bien lui laisser le temps (quelques minutes) de terminer ‚ö†Ô∏è

```bash
gpg/card> generate
Make off-card backup of encryption key? (Y/n) n

Please note that the factory settings of the PINs are
   PIN = '123456'     Admin PIN = '12345678'
You should change them using the command --change-pin

Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0) 3y
Key expires at Jeu  6 avr 11:02:54 2028 CEST
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: Pipo Bimbo
Email address: heroinedor@gmail.com
Comment:
You selected this USER-ID:
    "Pipo Bimbo <heroinedor@gmail.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
gpg: key 109F2428DD97A597 marked as ultimately trusted
gpg: revocation certificate stored as 'C:/Users/you/AppData/Roaming/gnupg/openpgp-revocs.d\2F28DCB202028A5A2FE5A45D109F2428DD97A597.rev'
public and secret key created and signed.
```

Normalement quand on a plusieurs Yubikey, on en utilise une pour stocker sa cl√© primaire et une autre pour stocker les sous-cl√©s.
Dans notre cas en l'absence (temporaire) de Yubikey suppl√©mentaire, on se contentera de ne g√©n√©rer qu'une seule cl√© PGP et de l'utiliser pour la suite du processus.

### **V√©rifier sa cl√© pgp**

Une fois la cr√©ation termin√©e, quitter le programme et le relancer. On peut ainsi v√©rifier la pr√©sence de la cl√© sur la yubikey

```bash
gpg/carte> list

Reader ...........: Yubico YubiKey OTP FIDO CCID 00 00
Application ID ...: D2760001240103040006181585420000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 18158542
Name of cardholder: [non positionn√©]
Language prefs ...: [non positionn√©]
Salutation .......:
URL of public key : [non positionn√©]
Login data .......: [non positionn√©]
Signature PIN ....: non forc√©
Key attributes ...: rsa4096 rsa4096 rsa4096
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 7
KDF setting ......: off
Signature key ....: 35FC 4FCA 4887 7127 E7F0  B29D 2FA2 7903 9EFA 1679
      created ....: 2024-09-18 14:19:38
Encryption key....: EE57 8EB2 6193 F607 A841  125A 220B 2314 5967 916F
      created ....: 2024-09-18 14:19:38
Authentication key: A248 2E3B 8E7A 1722 A310  6B39 5FCA 9BBB CAC3 ABE5
      created ....: 2024-09-18 14:19:38
General key info..:
pub  rsa4096/2FA279039EFA1679 2024-09-18 Pipo Bimbo <heroinedor@gmail.com>
sec>  rsa4096/2FA279039EFA1679  cr√©√© : 2024-09-18  expire : jamais
                                n¬∫ de carte : 0006 18158542
```

Noter l'indicatif de cl√© (key handle), ici le : 2FA279039EFA1679
Il servira dans la suite du processus

### **Exporter sa cl√© publique pgp**

Afin de pouvoir uploader la cl√© publique chez Github, il faut d'abord l'exporter :

```bash
$ gpg --armor --output yubikey_gpg_public.asc --export heroinedor@gmail.com
```

On peut retrouver la cl√© publique dans le fichier ainsi export√©

```bash
$ cat yubikey_gpg_public.asc
-----BEGIN PGP PUBLIC KEY BLOCK-----
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
-----END PGP PUBLIC KEY BLOCK-----
```

### **Importer sa cl√© publique pgp dans Github**

Le contenu de cette cl√© (y compris les lignes ----BEGIN/END----) sont √† importer dans le compte Github via le menu "settings"/"SSH and GPG Keys"

Suivre cette documentation pour y parvenir : [https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account](https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account)

### **Configurer Git pour la signature √©lectronique**

√Ä noter que comme pour toute configuration Git, elle peut √™tre effectu√©e :

- au niveau de l'installation globale sur la machine en rajoutant √† la ligne de commande `-global`
- ou au niveau du d√©p√¥t en rajoutant √† la ligne de commande `-local`

Indiquer √† Git l'indicatif de cl√© (key handle r√©cup√©r√© au chapitre v√©rifier sa cl√© pgp) √† utiliser :

```bash
$ git config --global user.signingKey 2FA279039EFA1679
```

Indiquer aussi √† Git d'utiliser la signature automatique afin de n'avoir pas √† le sp√©cifier √† chaque commit

```bash
$ git config --global commit.gpgsign true
```

Et enfin, indiquer √† Git quel programme PGP utiliser

- Linux

```bash
$ git config --global gpg.program gpg2
```

- macOS

```bash
$ git config --global gpg.program gpg
```

### **Effectuer son premier commit Git Sign√©**

Si tout s'est bien pass√©, il suffit maintenant d'effectuer un commit via Git pour que la signature soit automatiquement ajout√©e :

```bash
$ git commit -m "signature test"
[main 68e204c] signature test
 1 file changed, 2 insertions(+)
```

La pr√©sence de la signature peut √™tre v√©rifi√©e ainsi :

```bash
$ git log --show-signature
commit 68e204c945a95a2d8970a19552fdebcfdbb41864 (HEAD -> main)
gpg: Signature faite le lun. 23 sept. 2024 17:14:44 CEST
gpg:                avec la clef RSA 35FC4FCA48877127E7F0B29D2FA279039EFA1679
gpg: Bonne signature de ¬´ Pipo Bimbo <heroinedor@gmail.com> ¬ª [ultime]
Author: Pipo Bimbo <heroinedor@gmail.com>
Date:   Mon Sep 23 17:14:44 2024 +0200

    signature test
```

üéâ üéâ üéâ üéâ

## **Aller plus loin**

Gestion des clefs SSH avec FIDO2 et la yubikey : [https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html](Securing SSH Authentication with FIDO2)
Signer ses commits git avec la yubikey : [https://github.com/YubicoLabs/sign-git-commits-yubikey](https://github.com/YubicoLabs/sign-git-commits-yubikey)
