---
hide_table_of_contents: true
---

# 2FA / Security keys

Le probl√®me d'une authentification avec un simple mot de passe, c'est que si quelqu'un vous voit l'√©crire dans le train, ou vous le vole en √©tant √† l'autre bout du monde avec un virus, c'est alors "open bar", vous n'avez aucun moyen de limiter la casse.

C'est l√† o√π **le deuxi√®me facteur d'authentification (2FA) est primordial**, c'est normalement une s√©curit√© additionnelle proche de vous physiquement pour valider des op√©rations (de connexion dans notre contexte).

Ainsi, si :

- On vous pirate √† distance votre mot de passe, il manque au pirate le 2FA ;
- On vous vole votre 2FA, il manque au pirate le mot de passe.

Si jamais la personne arrive √† avoir votre mot de passe et votre 2FA‚Ä¶ Soit vous avez utilis√© un 2FA basique, soit vous √™tes victime d'un coup organis√©.

Il existe plusieurs types de 2FA :

1.  Validation par SMS (la moins s√©curis√©e en cas de vol de t√©l√©phone puisque souvent aucun besoin de le d√©verrouiller pour lire les SMS) ;
2.  Validation par l'application mobile du produit (les banques appellent souvent dans ce cas votre t√©l√©phone un "terminal de confiance") ;
3.  Validation par [TOTP](https://en.wikipedia.org/wiki/Time-based_one-time_password) (suite de chiffres valide 30 secondes) (souvent g√©r√© par une application nomm√©e `??? Authenticator`) ;
4.  Validation par une cl√© de s√©curit√© ([WebAuthn](https://en.wikipedia.org/wiki/WebAuthn) √©tant le dernier standard).

On va surtout s'int√©resser aux (3) et (4) qui sont les standards les plus utilis√©s pour l'authentification. Tout est bas√© sur une cl√© priv√©e unique stock√©e dans l'application `TOTP Authenticator`, ou dans votre cl√© de s√©curit√©. Ce qui permet de chiffrer une s√©quence d'autorisation durant une authentification.

**Si vous utilisez un gestionnaire de mots de passe, le 2FA est primordial üîë.**

Utiliser la (3) pour prot√©ger vos comptes **(en plus du gestionnaire)** est d√©j√† tr√®s bien, mais assurez-vous juste :

- Que votre TOTP Authenticator soit sauvegard√© automatiquement sur des serveurs et que vous ayez r√©cup√©r√© les "cl√©s de backup". Histoire que si vous perdez votre t√©l√©phone vous puissiez r√©installer l'application et retrouver tous les codes (sinon vous serez bloqu√©s sur tous vos comptes, et il est tr√®s rare que les supports r√©pondent pour d√©bloquer ce genre de situation) ;
- Que votre t√©l√©phone (si l'Authenticator est dessus) ainsi que l'Authenticator aient un code de verrouillage pour √™tre d√©bloqu√© (ou par empreinte digitale).

Sinon pour le (4), **nous recommandons √† ce que vous ayez quelqu'un autour de vous qui puisse vous montrer un peu comment √ßa marche au quotidien. C'est un processus plus √©toff√© que la (3) et qui demande un minimum de rigueur, il vaut donc mieux √™tre bien sensibilis√©.** Une cl√© de s√©curit√© ressemble √† une cl√© USB, sauf que son contenu ne peut pas √™tre lu (celui qui tente de la d√©monter grille obligatoirement le circuit et la cl√© priv√©e de chiffrement reste‚Ä¶ priv√©e puisque d√©truite). Il est tr√®s risqu√© d'en avoir qu'une car si vous la perdez (qui n'a jamais perdu de cl√© ?), vous perdez d'office votre seul moyen de 2FA.

Il est recommand√© d'utiliser 3 cl√©s de s√©curit√© minimum (elles ont donc chacune une cl√© priv√©e diff√©rente en leur sein) que vous configurerez sur chacun de vos comptes les plus sensibles (gestionnaire de mots de passe et bo√Ætes emails). Vous vous doutez bien, il ne faut pas garder vos 3 cl√©s ensemble, donc dans l'id√©al :

- Une sur vous en permanence quand des v√©rifications 2FA vous sont demand√©es (de pr√©f√©rence une cl√© qui fait USB+NFC afin de pouvoir √™tre utilis√© sur t√©l√©phone) ;
- Une cach√©e chez vous (sous le plancher‚Ä¶ comme il vous sied tant que vous puissiez la retrouver) ;
- Une cach√©e chez le fils de la cousine de la tante de votre p√®re üòé.

Si jamais vous perdez l'une des clefs, vous vous connectez avec l'une des cl√©s de secours sur tous vos comptes ayant √©t√© configur√© avec les cl√©s de s√©curit√©, puis vous supprimez l'ancienne et pour ajouter une nouvelle que vous venez d'acheter en remplacement.

Vous l'avez peut-√™tre d√©cel√© mais si vous souhaitiez utiliser la m√©thode "security key" sur chacun de vos comptes il faudrait √† chaque inscription avoir acc√®s √† toutes vos cl√©s (compliqu√© quand vous les avez cach√©es √† 50 kilom√®tres de chez vous). C'est pour cela que nous proposions de surtout configurer le gestionnaire et vos bo√Ætes emails, car ces comptes ne bougeront quasi pas dans le temps.

La technique ensuite pour les autres services "plus basiques" est d'utiliser le 2FA TOTP (m√©thode (3)). C'est votre gestionnaire de mots de passe qui va servir d'Authenticator pour g√©n√©rer les codes qui durent 30 secondes (normalement les gestionnaires ont cette fonctionnalit√©).

:::note Pas toujours le choix
Vous verrez que de toute fa√ßon vous n'aurez des fois pas le choix que d'adopter le (3) en 2FA. Hormis les services sp√©cialis√©s dans la s√©curit√©, l'option 2FA en cl√© de s√©curit√© est assez rare compar√© au TOTP.
:::

Si on r√©sume dans le cas d'un red√©marrage de mon ordinateur :

1.  Je souhaite me connecter sur un site `ABC` qui est prot√©g√© avec un 2FA TOTP ;
2.  Je lance mon gestionnaire, entre mon master password, et utilise ma cl√© de s√©curit√© pour passer le 2FA du gestionnaire ;
3.  Je copie/colle le mot de passe du site `ABC` ;
4.  Le site me demande le 2FA TOTP que je vais chercher dans mon gestionnaire (pour simplifier, souvent le gestionnaire va automatiquement le mettre dans le [presse-papier](<https://fr.wikipedia.org/wiki/Presse-papiers_(informatique)>) pour que vous n'ayez plus qu'√† le coller apr√®s un auto-remplissage des identifiants).

:::note Quoi acheter ?
La marque la plus connue et tr√®s appr√©ci√©e historiquement est [Yubico](https://www.yubico.com/) (su√©dois) avec ses Yubikeys, mais dor√©navant il existe plein d'alternatives (que nous n'avons pas test√©s).
:::

**Activer le 2FA est b√©n√©fique tout autant dans le cadre priv√© que dans le cadre professionnel. Nous recommandons que votre √©quipe utilise le 2FA dans tous vos outils.** Et quand c'est possible, de forcer dans l'outil le 2FA √† tous les membres.

_Notez qu'il est difficile de r√©sumer tous les cas d'utilisation de ces m√©thodes par √©crit, nous essayons ici de poser des bases afin de vous aider √† vous lancer._

# Cas des Yubikeys

Comme indiqu√© plus haut les Yubikey sont des clefs USB/dongles utilis√©s principalement pour s√©curiser l'authentification des utilisateurs √† leur compte, mais pas seulement.
Elles peuvent aussi servir √† authentifier les commits git.

Pour la suite de cette documentation Le type de Yubikey (USB-C, USB-A, etc.) n'est pas important. En revanche, nous travaillerons avec la s√©rie 5.
Normalement (√† par l'utilitaire ykman), ces commandes fonctionnent pour toutes les cl√©s compatibles FIDO2 (pour les acc√®s SSH/Passkeys) et carte √† puce (pour la partie PGP)

## **Installation**

La Yubikey vient avec plusieurs applications fournies par Yubico.
Celle qui nous int√©resse dans notre cas est le Yubikey-manager.

La documentation pour l'installer : [https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html](https://docs.yubico.com/software/yubikey/tools/ykman/Install_ykman.html)

Pour les clefs d'autres marques il existe fido-manager.

## **Authentification par passkeys**


## **Gestion des clefs SSH**

FIDO2 est un standard d'authentification sans mot de passe qui utilise la cryptographie √† cl√© publique pour s√©curiser les connexions en ligne.
Fido2 fonctionne avec SSH de la mani√®re suivante :
- la clef publique est partag√©e avec l'h√¥te distant
- la clef priv√©e n'est pas r√©ellement stock√©e sur la machine locale : le fichier de clef priv√© contient un ID qui r√©f√©rence la clef priv√©e stock√©e sur la yubikey

### **Cr√©ation**
La cr√©ation d'une clef se fait via l'utilitaire ssh-keygen :
```bash
ssh-keygen -t ed25519-sk -O resident -O application=ssh:github -C "cl√© pour acc√®s √† Github"
  ```
L'option "-O resident" sp√©cifie que la clef priv√©e est stock√©e dans la yubikey.
L'option "-O application=ssh:github" indique que la clef ssh g√©n√©r√©e aura pour ID "ssh:github" dans la yubikey.
Au moment o√π cette commande est valid√©e, le code PIN de la yubikey sera demand√©.
Ensuite, on retrouvera dans le r√©pertoire courant les fichiers publiques et priv√©s des clefs :
- id_ed25519_sk_rk_github
- id_ed25519_sk_rk_github.pub
Ces fichiers peuvent √™tre effac√©s, car nous les r√©cup√®rerons √† partir de la yubikey dans une √©tape suivante.

Dans le cas o√π on doit g√©n√©rer une autre clef SSH, on lui sp√©cifiera un autre nom.
Dans la commande suivante, elle aura pour ID "ssh:infra-prod"
```bash
ssh-keygen -t ed25519-sk -O resident -O application=ssh:infra-prod -C "cl√© pour acc√®s √† l'infra de prod"
  ```

### **Visualisation dans Yubikey-manager**
Pour visualiser les cl√©s pr√©c√©demment cr√©√©es saisir la commande suivante :
```bash
ykman fido credentials list
  ```
Apr√®s la saisie du code PIN, le r√©sultat pourra ressembler √† ceci :
```bash
Credential ID  RP ID       Username           Display name
a8f896e6...    ssh:github  openssh            openssh
e929dde6...    ssh:infra-prod    openssh            openssh
  ```
On a bien deux clefs ssh r√©f√©renc√©es sous 2 ID diff√©rents.

### **Import sur une machine**
Suite aux √©tapes pr√©c√©dentes, nous avons un couple de clefs priv√©e/publique  install√©s sur la yubikey.
Voici comment faire pour importer ces clefs sur une machine :
```bash
cd ~/.ssh
ssh-keygen -K
  ```
Les clefs sont maintenant stock√©es dans le r√©pertoire ~/.ssh et peuvent √™tre list√©es via :
```bash
~/.ssh$ ls
id_ed25519_sk_rk_github
id_ed25519_sk_rk_github.pub
id_ed25519_sk_rk_nubo
id_ed25519_sk_rk_nubo.pub
  ```

### **Utilisation dans git**
Maintenant que nos clefs sont import√©es sur la machine, nous allons nous en servir pour nous connecter √† un d√©p√¥t github.
Pour cela, nous allons configurer le fichier .ssh/config

```bash
cd ~/.ssh/
nano config
  ```
Saisir dans l'√©diteur de texte (nano ou vim ou autre) le texte suivant :
```
Host github.com
  IdentityFile /home/ {{USER}}/.ssh/id_ed25519_sk_rk_github
  ```
En rempla√ßant  {{USER}} par le nom de l'utilisateur linux qui utilisera la clef.
Remplacer "id_ed25519_sk_rk_github" par le nom du fichier de clef priv√©e qui devra √™tre pr√©sent√©.

√Ä noter que dans le cas o√π l'on a plusieurs clefs ssh pour se connecter √† plusieurs comptes github, on peut le sp√©cifier de mani√®re un peu diff√©rente :
- cr√©er le fichier /home/ {{USER}}/config.d/config-github et saisir ce qui a √©t√© pr√©ciser au dessus
- au moment de la connexion, pr√©ciser dans la variable d'environnement GIT_SSH_COMMAND le fichier de config ssh √† utiliser :
```bash
GIT_SSH_COMMAND="ssh -F /home/ {{USER}}/.ssh/config.d/config-github" git clone git@github.com:cloud-gouv/infra.git
  ```
Vous voil√† pr√™t √† travailler avec votre d√©p√¥t git !

## **Signer ses commits avec la Yubikey**

### **Installer et configurer GnuPG**

OpenPGP est un standard utilis√© pour la manipulation des cl√©s cryptographiques. Son impl√©mentation principale est GNU Privacy Guard (gnupg).

Voici les proc√©dures d'installation en fonction de l'OS:

- **Linux** :

Installer les paquets suivant avec le package-manager (apt) : GPG, pcscd, scdaemon

```bash
$ sudo apt install pcscd gnupg2 scdaemon
```

- **macOS** :

Installation via homebrew

```bash
$ brew install gnupg
  ```

Puis installation de Pinentry

```bash
$ brew install pinentry-mac
  ```

Ajouter au fichier ~/.gnupg/gpg-agent.conf:

```bash
pinentry-program /usr/local/bin/pinentry-mac
  ```

Ajouter au fichier  ~/.gnupg/scdaemon.conf :

```bash
disable-ccid
  ```

### **Test de l'installation**

Une fois cette installation termin√©e, on peut tester le bon fonctionnement de gpg en ins√©rant la Yubikey dans un port USB et en tapant :

```bash
$ gpg --card-status
```

Si ma carte est vierge alors devrait appara√Ætre le r√©sultat suivant :

```bash
Reader ...........: Yubico YubiKey OTP FIDO CCID 0
Application ID ...: D2760001240102010006078005150000
Version ..........: 2.1
Manufacturer .....: Yubico
Serial number ....: 07800515
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: not forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
```

### **Modifier les codes PIN et admin PIN**

Saisir dans un shell :

```bash
$ gpg --card-edit
```

‚Üí on se retrouve dans un prompt gpg/card

Saisir :

```bash
gpg/carte> admin
Les commandes d'administration sont permises
```

Les codes par d√©faut fournis avec les yubikeys sont :

- code PIN : 123456
- code admin PIN : 12345678

Nous allons changer ces codes par d√©faut :

```bash
gpg/carte> passwd
gpg: carte OpenPGP n¬∫ D2760001240103040006181585420000 d√©tect√©e

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir 1 pour modifier le code PIN, puis saisir le nouveau code choisi dans les 2 fen√™tres qui s'affichent.

L'affichage revient au menu :

```bash
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir 3 pour modifier le code admin PIN, puis saisir le nouveau code choisi dans les 2 fen√™tres qui s'affichent.

L'affichage revient au menu :

```bash
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Quel est votre choix ?
```

Saisir q pour sortir du menu.

### **Modifier les attributs de cl√©**

On va modifier les attributs de la Yubikey pour s'assurer d'utiliser les types de cl√©s les plus robustes disponibles : type RSA de taille 4096 bits.

```bash
gpg/card> key-attr
Changing card key attribute for: Signature key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
Changing card key attribute for: Encryption key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
Changing card key attribute for: Authentication key
Please select what kind of key you want:
   (1) RSA
   (2) ECC
Your selection? 1
What keysize do you want? (2048) 4096
The card will now be re-configured to generate a key of 4096 bits
```

### **Cr√©er sa cl√© pgp**

On peut maintenant g√©n√©rer notre cl√© PGP. Lorsque le prompt le demandera, on saisira les options suivantes :

- Dur√©e de validit√© de la cl√© : 0 (pas d'expiration)
- identit√© : saisir son nom, pr√©nom, adresse mail (sera utilis√© pour identifier la cl√©)

‚ö†Ô∏è une fois saisi 'O' pour Okay, la Yubikey peut mettre un certain temps √† g√©n√©rer la cl√© PGP, sans que le prompt r√©agisse. Il faut bien lui laisser le temps (quelques minutes) de terminer ‚ö†Ô∏è

```bash
gpg/card> generate
Make off-card backup of encryption key? (Y/n) n

Please note that the factory settings of the PINs are
   PIN = '123456'     Admin PIN = '12345678'
You should change them using the command --change-pin

Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0)
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: Pipo Bimbo
Email address: heroinedor@gmail.com
Comment:
You selected this USER-ID:
    "Pipo Bimbo <heroinedor@gmail.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
gpg: key 109F2428DD97A597 marked as ultimately trusted
gpg: revocation certificate stored as 'C:/Users/you/AppData/Roaming/gnupg/openpgp-revocs.d\2F28DCB202028A5A2FE5A45D109F2428DD97A597.rev'
public and secret key created and signed.
```

Normalement quand on a plusieurs Yubikey, on en utilise une pour stocker sa cl√© primaire et une autre pour stocker les sous-cl√©s.
Dans notre cas en l'absence (temporaire) de Yubikey suppl√©mentaire, on se contentera de ne g√©n√©rer qu'une seule cl√© PGP et de l'utiliser pour la suite du processus.

### **V√©rifier sa cl√© pgp**

Une fois la cr√©ation termin√©e, quitter le programme et le relancer. On peut ainsi v√©rifier la pr√©sence de la cl√© sur la yubikey

```bash
gpg/carte> list

Reader ...........: Yubico YubiKey OTP FIDO CCID 00 00
Application ID ...: D2760001240103040006181585420000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 18158542
Name of cardholder: [non positionn√©]
Language prefs ...: [non positionn√©]
Salutation .......:
URL of public key : [non positionn√©]
Login data .......: [non positionn√©]
Signature PIN ....: non forc√©
Key attributes ...: rsa4096 rsa4096 rsa4096
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 7
KDF setting ......: off
Signature key ....: 35FC 4FCA 4887 7127 E7F0  B29D 2FA2 7903 9EFA 1679
      created ....: 2024-09-18 14:19:38
Encryption key....: EE57 8EB2 6193 F607 A841  125A 220B 2314 5967 916F
      created ....: 2024-09-18 14:19:38
Authentication key: A248 2E3B 8E7A 1722 A310  6B39 5FCA 9BBB CAC3 ABE5
      created ....: 2024-09-18 14:19:38
General key info..:
pub  rsa4096/2FA279039EFA1679 2024-09-18 Pipo Bimbo <heroinedor@gmail.com>
sec>  rsa4096/2FA279039EFA1679  cr√©√© : 2024-09-18  expire : jamais
                                n¬∫ de carte : 0006 18158542
```

Noter l'indicatif de cl√© (key handle), ici le : 2FA279039EFA1679
Il servira dans la suite du processus

### **Exporter sa cl√© publique pgp**

Afin de pouvoir uploader la cl√© publique chez Github, il faut d'abord l'exporter :

```bash
$ gpg --armor --output yubikey_gpg_public.asc --export heroinedor@gmail.com
```

On peut retrouver la cl√© publique dans le fichier ainsi export√©

```bash
$ cat yubikey_gpg_public.asc
-----BEGIN PGP PUBLIC KEY BLOCK-----
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
-----END PGP PUBLIC KEY BLOCK-----
```

### **Importer sa cl√© publique pgp dans Github**

Le contenu de cette cl√© (y compris les lignes ----BEGIN/END----) sont √† importer dans le compte Github via le menu "settings"/"SSH and GPG Keys"

Suivre cette documentation pour y parvenir : [https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account](https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account)

### **Configurer Git pour la signature √©lectronique**

√Ä noter que comme pour toute configuration Git, elle peut √™tre effectu√©e :

- au niveau de l'installation globale sur la machine en rajoutant √† la ligne de commande `-global`
- ou au niveau du d√©p√¥t en rajoutant √† la ligne de commande `-local`

Indiquer √† Git l'indicatif de cl√© (key handle r√©cup√©r√© au chapitre v√©rifier sa cl√© pgp) √† utiliser :

```bash
$ git config --global user.signingKey 2FA279039EFA1679
```

Indiquer aussi √† Git d'utiliser la signature automatique afin de n'avoir pas √† le sp√©cifier √† chaque commit

```bash
$ git config --global commit.gpgsign true
```

Et enfin, indiquer √† Git quel programme PGP utiliser

- Linux

```bash
$ git config --global gpg.program gpg2
```

- macOS

```bash
$ git config --global gpg.program gpg
```

### **Effectuer son premier commit Git Sign√©**

Si tout s'est bien pass√©, il suffit maintenant d'effectuer un commit via Git pour que la signature soit automatiquement ajout√©e :

```bash
$ git commit -m "signature test"
[main 68e204c] signature test
 1 file changed, 2 insertions(+)
```

La pr√©sence de la signature peut √™tre v√©rifi√©e ainsi :

```bash
$ git log --show-signature
commit 68e204c945a95a2d8970a19552fdebcfdbb41864 (HEAD -> main)
gpg: Signature faite le lun. 23 sept. 2024 17:14:44 CEST
gpg:                avec la clef RSA 35FC4FCA48877127E7F0B29D2FA279039EFA1679
gpg: Bonne signature de ¬´ Pipo Bimbo <heroinedor@gmail.com> ¬ª [ultime]
Author: Pipo Bimbo <heroinedor@gmail.com>
Date:   Mon Sep 23 17:14:44 2024 +0200

    signature test
```

üéâ üéâ üéâ üéâ

## **Aller plus loin**

Gestion des clefs SSH avec FIDO2 et la yubikey : [https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html](Securing SSH Authentication with FIDO2)
Signer ses commits git avec la yubikey : [https://github.com/YubicoLabs/sign-git-commits-yubikey](https://github.com/YubicoLabs/sign-git-commits-yubikey)
